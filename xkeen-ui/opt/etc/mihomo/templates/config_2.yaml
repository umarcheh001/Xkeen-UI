# -------------------------------------------------------------
# 0. БАЗОВЫЕ НАСТРОЙКИ CORE И UI
# -------------------------------------------------------------
# Standard Proxy Port: Порт HTTP/SOCKS5 прокси для обычных приложений
port: 7890
# Socks Port: Порт SOCKS5 прокси
socks-port: 7891
# Allow LAN: Разрешить устройствам в локальной сети использовать этот прокси
allow-lan: true
# Mode: Режим работы (Rule: по правилам, Global: весь трафик через прокси, Direct: весь трафик напрямую)
mode: rule
# Log Level: Уровень логирования
log-level: info
# IPv6: Включить поддержку маршрутизации трафика IPv6
ipv6: true

# --- Улучшения ядра ---
# Unified Delay: Измерять задержку (latency) один раз для всей группы прокси
unified-delay: true
# TCP Concurrent: Разрешить использование нескольких TCP-соединений для одного сеанса (улучшение производительности)
tcp-concurrent: true
# Global Client Fingerprint: Маскировать исходящий трафик Mihomo под указанный браузер (для обхода некоторых детекторов)
global-client-fingerprint: chrome
# log-level: warning # Можно включить для уменьшения шума в логах

# Прозрачный прокси (Ключевые настройки для Keenetic)
# Redir Port: Порт для перенаправления (REDIRECT) - используется для TCP-трафика
redir-port: 7892
# Tproxy Port: Порт для прозрачного проксирования (TPROXY) - используется для UDP-трафика
tproxy-port: 7893

# Dashboard (Веб-интерфейс управления)
# External Controller: Адрес и порт, по которому доступен Dashboard (0.0.0.0 — доступ со всех интерфейсов)
external-controller: "0.0.0.0:9090"
# Secret: Пароль для доступа к Dashboard
secret: "admin"
# External UI: Имя папки, где лежит внешний UI (zashboard)
external-ui: ui
# External UI URL: URL для автоматической загрузки и установки кастомного веб-интерфейса
external-ui-url: "https://github.com/Zephyruso/zashboard/releases/download/v2.1.0/dist-no-fonts.zip"

profile:
  # Store Selected: Сохранять выбор прокси, сделанный пользователем в Dashboard, при перезагрузке
  store-selected: true

sniffer:
  # Enable Sniffer: Включить инспектор трафика для определения протоколов
  enable: true
  # Parse Pure IP: Пытаться определить доменное имя для трафика, идущего по IP-адресу
  parse-pure-ip: true
  # Force DNS Mapping: Принудительно отображать IP-адреса на доменные имена
  force-dns-mapping: true
  # Sniff: Указать протоколы, которые необходимо инспектировать
  sniff:
    HTTP:
    TLS:
    QUIC:

# -------------------------------------------------------------
# 1. ПРОВАЙДЕРЫ ПРОКСИ (PROXY-PROVIDERS)
# -------------------------------------------------------------
proxy-providers:
  my-vless-sub:
    type: http
    url: "подписка"
    path: ./proxy_providers/my-vless-sub.yaml # Путь, куда будет сохранен скачанный файл подписки
    interval: 3600 # Интервал обновления подписки (в секундах, 1 час)
    health-check:
      enable: true
      url: "http://www.gstatic.com/generate_204" # URL для проверки работоспособности узла (успех = 204)
      interval: 300 # Интервал проверки работоспособности узлов (5 минут)
      timeout: 8000 # Тайм-аут проверки (8 секунд)
      lazy: true # Запускать проверку только при первом использовании узла
      expected-status: 204
    override: # Переопределение настроек прокси-узлов
      tfo: true # Включить TCP Fast Open
      mptcp: true # Включить MultiPath TCP (если поддерживается)
      udp: true # Включить проксирование UDP-трафика

  second-sub:
    type: http
    url: "подписка"
    path: ./proxy_providers/second-sub.yaml
    interval: 3600
    health-check:
      enable: true
      url: "http://www.gstatic.com/generate_204"
      interval: 300
      timeout: 8000
      lazy: true
      expected-status: 204
    override:
      tfo: true
      mptcp: true
      udp: true

  third-sub:
    type: http
    url: "подписка"
    path: ./proxy_providers/third-sub.yaml
    interval: 3600
    health-check:
      enable: true
      url: "http://www.gstatic.com/generate_204"
      interval: 300
      timeout: 8000
      lazy: true
      expected-status: 204
    override:
      tfo: true
      mptcp: true
      udp: true

# -------------------------------------------------------------
# 2. ГРУППЫ ПРОКСИ (PROXY-GROUPS)
# -------------------------------------------------------------
proxy-groups:
  - name: Auto-VPN
    type: url-test # Автоматический выбор узла с наименьшей задержкой
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Rocket.png"
    use: # Использует узлы из указанных прокси-провайдеров
      - my-vless-sub
      - second-sub
      - third-sub
    url: "http://www.gstatic.com/generate_204" # URL для проверки задержки
    interval: 300 # Интервал проверки задержки (5 минут)
    tolerance: 50 # Допуск задержки
    lazy: true

  - name: Proxy-Selector
    type: select # Группа для ручного выбора
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Proxy.png"
    use: # Добавляет все узлы из подписок в список для ручного выбора
      - my-vless-sub
      - second-sub
      - third-sub
    proxies:
      - Auto-VPN # Возможность выбрать автоматический выбор
      - DIRECT # Возможность выбрать прямое соединение
    default: DIRECT # Значение по умолчанию при старте

  - name: Ru-Traffic
    type: select # Выбор для российского трафика
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Russia.png"
    use: # Добавляет все узлы из подписок (если вдруг понадобится прокси для российских ресурсов)
      - my-vless-sub
      - second-sub
      - third-sub
    proxies:
      - DIRECT
    default: DIRECT # По умолчанию прямой маршрут

  - name: Ad-Filter
    type: select # Группа для блокировки рекламы и нежелательного контента
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/AdBlack.png"
    proxies:
      - REJECT # Блокировать соединение
      - DIRECT
    default: REJECT # По умолчанию блокировать

  - name: ECH-Refilter
    type: select # Группа для доменов с ECH, которые могут вызывать проблемы
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Direct.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector # По умолчанию через прокси

  - name: META
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Facebook.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector # Facebook, Instagram часто блокируются

  - name: AMAZON
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Amazon.png"
    proxies:
      - DIRECT
      - Proxy-Selector
    default: DIRECT

  - name: FASTLY
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - DIRECT
      - Proxy-Selector
    default: DIRECT

  - name: AKAMAI
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - DIRECT
      - Proxy-Selector
    default: DIRECT

  - name: GOOGLE-ЮТУБ
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Google.png"
    use:
      - my-vless-sub
      - second-sub
      - third-sub
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector

  - name: CLOUDFLARE
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Cloudflare.png"
    proxies:
      - DIRECT
      - Proxy-Selector
    default: DIRECT

  - name: CDN77
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - DIRECT
      - Proxy-Selector
    default: DIRECT

  - name: DIGITALOCEAN
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - DIRECT
      - Proxy-Selector
    default: DIRECT

  - name: HETZNER
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - DIRECT
      - Proxy-Selector
    default: DIRECT

  - name: MEGA
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - DIRECT
      - Proxy-Selector
    default: DIRECT

  - name: ORACLE
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - DIRECT
      - Proxy-Selector
    default: DIRECT

  - name: OVH
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - DIRECT
      - Proxy-Selector
    default: DIRECT

  - name: VULTR
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - DIRECT
      - Proxy-Selector
    default: DIRECT

  - name: Telegram
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Telegram.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector

  - name: Steam
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Steam.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector

  - name: Discord
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Discord.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector

  - name: Torrent-Traffic
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Download.png"
    proxies:
      - DIRECT
      - Proxy-Selector
      - REJECT
    default: DIRECT # Торренты обычно идут напрямую

  - name: Politic-Domains
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Media.png"
    proxies:
      - DIRECT
      - Proxy-Selector
    default: DIRECT

  - name: Other-Domains
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Puzzle.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector # Общий набор заблокированных доменов

  - name: Global-Default
    type: select # Финальная группа для всего немаршрутизированного трафика
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Final.png"
    proxies:
      - DIRECT
      - Proxy-Selector
    default: DIRECT

# -------------------------------------------------------------
# 3. ПРОВАЙДЕРЫ ПРАВИЛ (RULE-PROVIDERS)
# Здесь подключаются внешние списки IP и доменов.
# -------------------------------------------------------------
rule-providers:
  # 3.1. AI и дев-сервисы (inline список доменов)
  github-ai:
    type: inline
    behavior: classical
    format: text
    payload:
      - DOMAIN-SUFFIX,githubcopilot.com
      - DOMAIN-SUFFIX,github.dev
      - DOMAIN-SUFFIX,github.com
      - DOMAIN-SUFFIX,githubusercontent.com
      - DOMAIN-SUFFIX,copilot-proxy.githubusercontent.com
      - DOMAIN-SUFFIX,telemetry.individual.githubcopilot.com
      - DOMAIN-SUFFIX,main.vscode-cdn.net
      - DOMAIN-SUFFIX,api.github.com
      - DOMAIN-SUFFIX,vscode.dev
      - DOMAIN-SUFFIX,api.individual.githubcopilot.com
      - DOMAIN-SUFFIX,marketplace.visualstudio.com
      - DOMAIN-SUFFIX,vscode-cdn.net
      - DOMAIN-SUFFIX,vscode.microsoft.com
      - DOMAIN-SUFFIX,code.visualstudio.com
      - DOMAIN-KEYWORD,copilot
      - DOMAIN-KEYWORD,vscode
      - DOMAIN-KEYWORD,github
      - DOMAIN-SUFFIX,copilot.microsoft.com
      - DOMAIN-SUFFIX,bing.com
      - DOMAIN-SUFFIX,microsoftcopilot.app
      - DOMAIN-SUFFIX,sydney.bing.com
      - DOMAIN-SUFFIX,edgeservices.bing.com
      - DOMAIN-SUFFIX,copilot.live.com
      - DOMAIN-SUFFIX,openai.com
      - DOMAIN-SUFFIX,api.openai.com
      - DOMAIN-SUFFIX,chat.openai.com
      - DOMAIN-SUFFIX,chatgpt.com
      - DOMAIN-SUFFIX,platform.openai.com
      - DOMAIN-KEYWORD,openai
      - DOMAIN-KEYWORD,chatgpt
      - DOMAIN-SUFFIX,gemini.google.com
      - DOMAIN-SUFFIX,bard.google.com
      - DOMAIN-SUFFIX,ai.google.dev
      - DOMAIN-SUFFIX,ai.google.com
      - DOMAIN-SUFFIX,makersuite.google.com
      - DOMAIN-SUFFIX,generativeai.google
      - DOMAIN-SUFFIX,aistudio.google.com
      - DOMAIN-KEYWORD,gemini
      - DOMAIN-KEYWORD,bard
      - DOMAIN-SUFFIX,claude.ai
      - DOMAIN-SUFFIX,anthropic.com
      - DOMAIN-SUFFIX,console.anthropic.com
      - DOMAIN-KEYWORD,claude
      - DOMAIN-KEYWORD,anthropic
      - DOMAIN-SUFFIX,x.ai
      - DOMAIN-SUFFIX,grok.x.ai
      - DOMAIN-SUFFIX,api.x.ai
      - DOMAIN-KEYWORD,grok
      - DOMAIN-SUFFIX,perplexity.ai
      - DOMAIN-SUFFIX,pplx.ai
      - DOMAIN-KEYWORD,perplexity
      - DOMAIN-SUFFIX,huggingface.co
      - DOMAIN-SUFFIX,hf.co
      - DOMAIN-SUFFIX,huggingface.com
      - DOMAIN-KEYWORD,huggingface
      - DOMAIN-SUFFIX,midjourney.com
      - DOMAIN-SUFFIX,cdn.midjourney.com
      - DOMAIN-KEYWORD,midjourney
      - DOMAIN-SUFFIX,stability.ai
      - DOMAIN-SUFFIX,stablediffusionweb.com
      - DOMAIN-SUFFIX,dreamstudio.ai
      - DOMAIN-SUFFIX,runwayml.com
      - DOMAIN-SUFFIX,runway.ml
      - DOMAIN-SUFFIX,character.ai
      - DOMAIN-SUFFIX,beta.character.ai
      - DOMAIN-SUFFIX,replicate.com
      - DOMAIN-SUFFIX,cohere.ai
      - DOMAIN-SUFFIX,cohere.com
      - DOMAIN-SUFFIX,jetbrains.com
      - DOMAIN-SUFFIX,replit.com
      - DOMAIN-SUFFIX,repl.it
      - DOMAIN-SUFFIX,stackoverflow.com
      - DOMAIN-SUFFIX,docker.com
      - DOMAIN-SUFFIX,docker.io
      - DOMAIN-SUFFIX,npmjs.com
      - DOMAIN-SUFFIX,pypi.org

  # 3.2. Облачные сети по IP (Anton111111)
  akamai_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/akamai_ips.list"
    path: ./rule-sets/akamai_ips.list
    interval: 86400

  amazon_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/amazon_ips.list"
    path: ./rule-sets/amazon_ips.list
    interval: 86400

  cdn77_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/cdn77_ips.list"
    path: ./rule-sets/cdn77_ips.list
    interval: 86400

  cloudflare_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/cloudflare_ips.list"
    path: ./rule-sets/cloudflare_ips.list
    interval: 86400

  digitalocean_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/digitalocean_ips.list"
    path: ./rule-sets/digitalocean_ips.list
    interval: 86400

  fastly_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/fastly_ips.list"
    path: ./rule-sets/fastly_ips.list
    interval: 86400

  google_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/google_ips.list"
    path: ./rule-sets/google_ips.list
    interval: 86400

  hetzner_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/hetzner_ips.list"
    path: ./rule-sets/hetzner_ips.list
    interval: 86400

  mega_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/mega_ips.list"
    path: ./rule-sets/mega_ips.list
    interval: 86400

  meta_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/meta_ips.list"
    path: ./rule-sets/meta_ips.list
    interval: 86400

  oracle_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/oracle_ips.list"
    path: ./rule-sets/oracle_ips.list
    interval: 86400

  ovh_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/ovh_ips.list"
    path: ./rule-sets/ovh_ips.list
    interval: 86400

  vultr_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/vultr_ips.list"
    path: ./rule-sets/vultr_ips.list
    interval: 86400

  # 3.3. Сервисные списки доменов/IP
  other_domains:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/other.list" 
    path: ./rule-sets/other.list
    interval: 86400

  extra-proxy-domains:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251109-014029-835e3fe/domains.list"
    path: ./rule-sets/extra-proxy-domains.list
    interval: 86400

  politic_domains:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/politic.list"
    path: ./rule-sets/politic.list
    interval: 86400

  telegram-ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/telegram_ips.list"
    path: ./rule-sets/telegram-ips.list
    interval: 86400

  ru-ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/ru_ips.list"
    path: ./rule-sets/ru-ips.list
    interval: 86400

  # 3.4. Discord IP и домены
  discord_voiceips:
    type: http
    behavior: ipcidr
    format: mrs
    url: "https://raw.githubusercontent.com/legiz-ru/mihomo-rule-sets/main/other/discord-voice-ip-list.mrs"
    path: ./rule-sets/discord-voice-ip-list.mrs
    interval: 86400

  discord_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/discord_ips.list"
    path: ./rule-sets/discord_ips.list
    interval: 86400

  discord_domains:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/meta/geo/geosite/discord.mrs"
    path: ./rule-sets/discord_domains.mrs
    interval: 86400

  # 3.5. Игровые IP и российские приложения
  gaming-ips:
    type: http
    behavior: ipcidr
    format: yaml
    url: "https://raw.githubusercontent.com/OMchik33/custom-rules/main/mihomo/gaming-ips.yaml"
    path: ./rule-sets/gaming-ips.yaml
    interval: 86400

  ru-app-list:
    type: http
    behavior: classical
    format: yaml
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/other/ru-app-list.yaml"
    path: ./rule-sets/ru-app-list.yaml
    interval: 86400

  steam-domain:
    type: http
    behavior: domain
    format: yaml
    url: "https://raw.githubusercontent.com/OMchik33/custom-rules/refs/heads/main/mihomo/gaming-domains.yaml"
    path: ./rule-sets/steam-domain.yaml
    interval: 86400

  # 3.6. Re-filter (ECH логика)
  refilter_noech:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/re-filter/re-filter-noech.mrs"
    path: ./re-filter/noech.mrs
    interval: 86400

  refilter_ech:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/re-filter/re-filter-ech.mrs"
    path: ./re-filter/ech.mrs
    interval: 86400

  refilter_ipsum:
    type: http
    behavior: ipcidr
    format: mrs
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/re-filter/ip-rule.mrs"
    path: ./re-filter/ip-rule.mrs
    interval: 86400

  # 3.7. Торрент клиенты, трекеры и сайты
  torrent-clients:
    type: http
    behavior: classical
    format: yaml
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/other/torrent-clients.yaml"
    path: ./rule-sets/torrent-clients.yaml
    interval: 86400

  torrent-trackers:
    type: http
    behavior: domain
    format: mrs
    url: "https://raw.githubusercontent.com/legiz-ru/mihomo-rule-sets/main/other/torrent-trackers.mrs"
    path: ./rule-sets/torrent-trackers.mrs
    interval: 86400

  torrent-websites:
    type: http
    behavior: domain
    format: mrs
    url: "https://raw.githubusercontent.com/legiz-ru/mihomo-rule-sets/main/other/torrent-websites.mrs"
    path: ./rule-sets/torrent-websites.mrs
    interval: 86400

  # 3.8. OISD списки рекламы и NSFW
  oisd_big:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/oisd/big.mrs"
    path: ./oisd/big.mrs
    interval: 86400

  oisd_small:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/oisd/small.mrs"
    path: ./oisd/small.mrs
    interval: 86400

  oisd_nsfw_small:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/oisd/nsfw_small.mrs"
    path: ./oisd/nsfw_small.mrs
    interval: 86400

  oisd_nsfw_big:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/oisd/nsfw.mrs"
    path: ./oisd/nsfw_big.mrs
    interval: 86400

# -------------------------------------------------------------
# 4. ПРАВИЛА МАРШРУТИЗАЦИИ (RULES)
# Порядок важен: первое совпавшее правило применяется.
# -------------------------------------------------------------
rules:
  # 4.0. Локальные сети и системный трафик (всегда DIRECT)
  - IP-CIDR,192.168.0.0/16,DIRECT,no-resolve
  - IP-CIDR,10.0.0.0/8,DIRECT,no-resolve
  - IP-CIDR,172.16.0.0/12,DIRECT,no-resolve
  - IP-CIDR,127.0.0.0/8,DIRECT,no-resolve
  - DST-PORT,53,DIRECT # DNS уходит на роутер напрямую

  # 4.1. Блокировка рекламы и торренты
  - RULE-SET,oisd_small,Ad-Filter
  - RULE-SET,oisd_big,Ad-Filter
  - RULE-SET,oisd_nsfw_small,Ad-Filter
  - RULE-SET,oisd_nsfw_big,Ad-Filter

  # Торрент-клиенты и трекеры идут в группу Torrent-Traffic
  - OR,((RULE-SET,torrent-clients),(RULE-SET,torrent-trackers)),Torrent-Traffic
  - RULE-SET,torrent-websites,Proxy-Selector

  # 4.2. Российские приложения и IP
  - RULE-SET,ru-app-list,DIRECT
  - RULE-SET,ru-ips,Ru-Traffic

  # 4.3. Сервисы, которые нужно вести через отдельные группы
  - RULE-SET,github-ai,Proxy-Selector
  - RULE-SET,other_domains,Other-Domains
  - RULE-SET,politic_domains,Politic-Domains
  - RULE-SET,extra-proxy-domains,Proxy-Selector

  # Определение внешнего IP через прокси
  - OR,((DOMAIN,ipwho.is),(DOMAIN,api.ip.sb),(DOMAIN,ipapi.co),(DOMAIN,ipinfo.io),(DOMAIN,2ip.io),(DOMAIN,2ip.ru)),Proxy-Selector

  # 4.4. Мессенджеры, стриминг, игры
  
  - RULE-SET,telegram-ips,Telegram

  # Discord: домены, IP-списки и специфические порты
  - OR,((RULE-SET,discord_domains),(RULE-SET,discord_ips),(RULE-SET,discord_voiceips),(DST-PORT,3478-3480),(DST-PORT,5222-5223),(DST-PORT,5228),(DST-PORT,5242),(DST-PORT,50000-50100)),Discord

  # Steam и игровые порты
  - OR,((RULE-SET,steam-domain),(RULE-SET,gaming-ips),(DST-PORT,3659),(DST-PORT,14000-14016),(DST-PORT,18000),(DST-PORT,20000-26000),(DST-PORT,21000-21500),(DST-PORT,23000-24000),(DST-PORT,27015),(DST-PORT,27031-27036),(DST-PORT,27036)),Steam

  # 4.5. Крупные облачные IP-сети (CDN)
  - RULE-SET,akamai_ips,AKAMAI
  - RULE-SET,amazon_ips,AMAZON
  - RULE-SET,fastly_ips,FASTLY
  - RULE-SET,google_ips,GOOGLE-ЮТУБ # Сюда попадут IP-адреса YouTube в том числе
  - RULE-SET,cloudflare_ips,CLOUDFLARE
  - RULE-SET,cdn77_ips,CDN77

  # 4.6. Re-filter и ECH
  - DOMAIN,cloudflare-ech.com,ECH-Refilter
  - RULE-SET,refilter_ech,DIRECT
  - RULE-SET,refilter_noech,ECH-Refilter
  - RULE-SET,refilter_ipsum,ECH-Refilter

  # 4.7. Остальные облачные и хостинг-провайдеры
  - RULE-SET,meta_ips,META
  - RULE-SET,digitalocean_ips,DIGITALOCEAN
  - RULE-SET,hetzner_ips,HETZNER
  - RULE-SET,mega_ips,MEGA
  - RULE-SET,oracle_ips,ORACLE
  - RULE-SET,ovh_ips,OVH
  - RULE-SET,vultr_ips,VULTR

  # 4.8. Общий запасной контур для голосовых вызовов и игровых чатов
  - OR,((DST-PORT,596-599),(DST-PORT,1400),(DST-PORT,3478-3480),(DST-PORT,4379-4380),(DST-PORT,5222),(DST-PORT,5223),(DST-PORT,5228),(DST-PORT,5242),(DST-PORT,6250),(DST-PORT,12000-65535),(DST-PORT,27101-65535),(DST-PORT,45395),(DST-PORT,50318),(DST-PORT,59234)),Proxy-Selector

  # 4.10. Финальное правило: все остальное в Global-Default
  - MATCH,Global-Default
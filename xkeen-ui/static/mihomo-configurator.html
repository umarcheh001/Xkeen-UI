<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Mihomo Universal config.yaml Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f5f7;
      --bg-elevated: rgba(255, 255, 255, 0.9);
      --border: #e0e0e5;
      --border-strong: #d0d0d5;
      --text: #111111;
      --text-soft: #555555;
      --accent: #007aff;
      --accent-hover: #0a84ff;
      --accent-press: #0060df;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.07);
      --input-bg: #ffffff;
      --tab-bg: #e3e4ea;
      --tab-active-bg: #ffffff;
      --tab-active-border: #c0c0c8;
      --preview-bg: #f2f2f5;
      --scrollbar: #c4c4cc;
    }

    body.dark {
      --bg: #1c1c1e;
      --bg-elevated: rgba(44, 44, 46, 0.98);
      --border: #3a3a3c;
      --border-strong: #48484a;
      --text: #f5f5f7;
      --text-soft: #a0a0ab;
      --accent: #0a84ff;
      --accent-hover: #4095ff;
      --accent-press: #0071e3;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.7);
      --input-bg: #2c2c2e;
      --tab-bg: #2c2c2e;
      --tab-active-bg: #1c1c1e;
      --tab-active-border: #48484a;
      --preview-bg: #111111;
      --scrollbar: #5a5a5f;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", system-ui, sans-serif;
      background: radial-gradient(circle at top left, #ffffff 0, var(--bg) 40%, var(--bg) 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app-shell {
      max-width: 1120px;
      width: 100%;
      margin: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .window {
      background: var(--bg-elevated);
      border-radius: 26px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(30px);
      -webkit-backdrop-filter: blur(30px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 640px;
    }

    .window-header {
      display: flex;
      align-items: center;
      padding: 10px 16px 8px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      gap: 10px;
    }

    .traffic-lights {
      display: flex;
      gap: 6px;
      padding: 0 4px;
    }
    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 1px solid rgba(0, 0, 0, 0.15);
    }
    .dot.red { background: #ff5f57; }
    .dot.yellow { background: #febc2e; }
    .dot.green { background: #28c840; }

    .window-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-soft);
      flex: 1;
      text-align: center;
      margin-right: 52px;
    }

    .theme-toggle {
      margin-left: auto;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.05);
      cursor: pointer;
      font-size: 12px;
      color: var(--text-soft);
      transition: background 0.15s ease, border-color 0.15s ease;
    }
    body.dark .theme-toggle {
      background: rgba(0, 0, 0, 0.25);
    }
    .theme-toggle:hover { border-color: var(--accent); }
    .theme-toggle input { display: none; }

    .theme-pill {
      width: 32px;
      height: 18px;
      border-radius: 999px;
      background: var(--border-strong);
      position: relative;
      padding: 2px;
      box-sizing: border-box;
    }
    .theme-knob {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #ffffff;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    body.dark .theme-knob {
      transform: translateX(14px);
    }

    .window-body {
      padding: 18px 22px 18px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow: hidden;
    }

    .title-block h1 {
      font-size: 22px;
      margin: 0 0 4px;
      font-weight: 600;
    }
    .title-block p {
      margin: 0;
      font-size: 13px;
      color: var(--text-soft);
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 11px;
      color: var(--text-soft);
      background: rgba(0, 0, 0, 0.02);
    }

    .profile-selector {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--tab-bg);
      padding: 2px;
      gap: 2px;
      margin-top: 8px;
    }
    .profile-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 12px;
      background: transparent;
      font-size: 12px;
      cursor: pointer;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .profile-btn span.icon { font-size: 14px; }
    .profile-btn.active {
      background: var(--tab-active-bg);
      color: var(--text);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.12);
      border: 1px solid var(--tab-active-border);
    }

    .profile-note {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .tabs {
      display: inline-flex;
      background: var(--tab-bg);
      padding: 3px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.07);
      gap: 2px;
      margin-top: 10px;
    }
    .tab-btn {
      border: none;
      background: transparent;
      padding: 5px 14px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .tab-btn span.icon { font-size: 14px; }
    .tab-btn.active {
      background: var(--tab-active-bg);
      color: var(--text);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.12);
      border: 1px solid var(--tab-active-border);
    }

    .tab-content {
      flex: 1;
      overflow: hidden;
      margin-top: 8px;
    }
    .tab-pane {
      display: none;
      height: 100%;
    }
    .tab-pane.active {
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: 100%;
    }

    .card {
      background: var(--bg-elevated);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 14px 16px 16px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.03);
    }

    .card h2 {
      font-size: 15px;
      margin: 0 0 10px;
      font-weight: 600;
    }

    .sub-input-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .sub-input-row label {
      width: 20px;
      font-size: 13px;
      color: var(--text-soft);
      text-align: right;
    }

    input[type="text"] {
      flex: 1;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border-strong);
      background: var(--input-bg);
      color: var(--text);
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.15);
    }

    .hint {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .checkbox-group-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
      gap: 12px;
    }
    .checkbox-group-header span {
      font-size: 13px;
      font-weight: 600;
    }
    .checkbox-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 4px 18px;
      margin-top: 6px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }
    .checkbox-item input[type="checkbox"] {
      width: 14px;
      height: 14px;
      accent-color: var(--accent);
    }

    .actions-row {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 6px;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.05);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text);
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.05s ease;
    }
    .btn:hover {
      border-color: var(--accent);
      background: rgba(0, 0, 0, 0.02);
    }
    .btn:active {
      transform: translateY(1px);
    }
    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #ffffff;
    }
    .btn-primary:hover {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
    }
    .btn-primary:active {
      background: var(--accent-press);
    }

    .preview-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 400px;
    }
    .preview-label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .preview-label-row span {
      font-size: 13px;
      font-weight: 600;
    }
    .preview-label-row .chip {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.04);
      color: var(--text-soft);
      border: 1px solid var(--border);
    }

    .preview {
      flex: 1;
      width: 100%;
      border-radius: 14px;
      border: 1px solid var(--border-strong);
      padding: 10px 12px;
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background: var(--preview-bg);
      color: var(--text);
      white-space: pre;
      overflow: auto;
    }
    .preview::-webkit-scrollbar {
      width: 8px;
    }
    .preview::-webkit-scrollbar-thumb {
      background: var(--scrollbar);
      border-radius: 4px;
    }

    .yaml-key {
      color: #b53a2a;
      font-weight: 500;
    }
    .yaml-comment {
      color: #86868b;
    }
    body.dark .yaml-key {
      color: #ff9f0a;
    }
    body.dark .yaml-comment {
      color: #98989f;
    }

    .footer-note {
      font-size: 11px;
      color: var(--text-soft);
      text-align: right;
      padding: 0 2px 2px;
    }

    .router-rules-card {
      display: none;
    }

    @media (max-width: 720px) {
      html, body {
        height: auto;
        min-height: 100%;
      }
      body {
        display: block;
        justify-content: flex-start;
        align-items: flex-start;
      }
      .app-shell {
        margin: 12px 8px 16px;
      }
      .window {
        min-height: auto;
        border-radius: 20px;
      }
      .window-body { padding: 14px; }
      .card { padding: 12px; }
      .checkbox-list {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="window">
      <div class="window-header">
        <div class="traffic-lights">
          <div class="dot red"></div>
          <div class="dot yellow"></div>
          <div class="dot green"></div>
        </div>
        <div class="window-title">Mihomo Universal config.yaml Generator</div>

        <label class="theme-toggle" id="themeToggleLabel">
          <input type="checkbox" id="themeToggle" />
          <div class="theme-pill">
            <div class="theme-knob"></div>
          </div>
          <span id="themeLabelText">–°–≤–µ—Ç–ª–∞—è</span>
        </label>
      </div>

      <div class="window-body">
        <div class="title-block">
          <h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä config.yaml –¥–ª—è Mihomo</h1>
          <p>
            –û–¥–∏–Ω –æ—Ñ–ª–∞–π–Ω-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä –¥–ª—è –¥–≤—É—Ö —Ä–µ–∂–∏–º–æ–≤:
            <strong>–∫–ª–∏–µ–Ω—Ç (—Å–º–∞—Ä—Ç—Ñ–æ–Ω / –ü–ö)</strong> –∏ <strong>—Ä–æ—É—Ç–µ—Ä Keenetic (zkeen)</strong>.
            –†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –±–µ–∑ Python –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤.
          </p>
          <div class="badge-row">
            <div class="badge">–†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω</div>
            <div class="badge">–¢–µ–º–∞: —Å–≤–µ—Ç–ª–∞—è / —Ç—ë–º–Ω–∞—è</div>
            <div class="badge">–ü—Ä–æ—Ñ–∏–ª–∏: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ / –†–æ—É—Ç–µ—Ä</div>
          </div>

          <div class="profile-selector" id="profileSelector">
            <button class="profile-btn active" data-profile="app">
              <span class="icon">üì±</span> –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (—Å–º–∞—Ä—Ç—Ñ–æ–Ω / –ü–ö)
            </button>
            <button class="profile-btn" data-profile="router">
              <span class="icon">üì°</span> –†–æ—É—Ç–µ—Ä Keenetic (zkeen)
            </button>
          </div>
          <div class="profile-note" id="profileNote">
            –°–µ–π—á–∞—Å –≤—ã–±—Ä–∞–Ω –ø—Ä–æ—Ñ–∏–ª—å <strong>–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</strong> (Mihomo / Clash Meta –Ω–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–µ –∏–ª–∏ –ü–ö).
            –≠—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å <strong>–Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç</strong> –¥–ª—è –ø—Ä—è–º–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ.
          </div>
        </div>

        <div class="tabs">
          <button class="tab-btn active" data-tab="settings">
            <span class="icon">‚öôÔ∏è</span>
            –ù–∞—Å—Ç—Ä–æ–π–∫–∏
          </button>
          <button class="tab-btn" data-tab="preview">
            <span class="icon">üìÑ</span>
            –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä YAML
          </button>
        </div>

        <div class="tab-content">
          <div class="tab-pane active" id="tab-settings">
            <!-- –û–±—â–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ -->
            <div class="card">
              <h2>–ü–æ–¥–ø–∏—Å–∫–∏ / VLESS (1‚Äì5)</h2>
              <div id="subs-container"></div>
              <div class="hint" id="subsHint">
                –î–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Ä–æ—É—Ç–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫/VLESS. –ü—É—Å—Ç—ã–µ –ø–æ–ª—è –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è.
              </div>
            </div>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
            <div id="appSettingsBlock">
              <div class="card">
                <div class="checkbox-group-header">
                  <span>–ì—Ä—É–ø–ø—ã –ø—Ä–æ–∫—Å–∏ (proxy-groups, –ø—Ä–æ—Ñ–∏–ª—å: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)</span>
                  <label class="checkbox-item" style="font-size: 12px;">
                    <input type="checkbox" id="selectAllGroups" />
                    –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                  </label>
                </div>
                <div id="proxy-groups-list" class="checkbox-list"></div>
              </div>

              <div class="card">
                <div class="checkbox-group-header">
                  <span>–ü—Ä–∞–≤–∏–ª–∞ (rule-providers + rules, –ø—Ä–æ—Ñ–∏–ª—å: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)</span>
                  <label class="checkbox-item" style="font-size: 12px;">
                    <input type="checkbox" id="selectAllRules" />
                    –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                  </label>
                </div>
                <div id="rules-list" class="checkbox-list"></div>
              </div>
            </div>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è —Ä–æ—É—Ç–µ—Ä–∞ -->
            <div id="routerSettingsBlock" style="display:none;">
              <div class="card">
                <h2>–ü—Ä–æ—Ñ–∏–ª—å —Ä–æ—É—Ç–µ—Ä–∞ Keenetic (zkeen)</h2>
                <p class="hint">
                  –í —ç—Ç–æ–º –ø—Ä–æ—Ñ–∏–ª–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≥—Ä—É–ø–ø—ã:
                  <strong>Auto-VPN, Proxy-Selector, Ad-Filter, ECH-Refilter, Torrent-Traffic, LINODE</strong> –∏ –¥—Ä.,
                  –∞ —Ç–∞–∫–∂–µ GEOIP/GEOSITE-–ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≥–µ–æ–±–∞–∑ <strong>zkeen</strong>.
                  –¢—ã –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—à—å —Å–≤–æ–∏ —Å—Å—ã–ª–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –≤—ã–±–∏—Ä–∞–µ—à—å –Ω—É–∂–Ω—ã–µ –±–ª–æ–∫–∏ –ø—Ä–∞–≤–∏–ª.
                </p>
              </div>

              <div class="card">
                <div class="checkbox-group-header">
                  <span>–ì—Ä—É–ø–ø—ã –ø—Ä–æ–∫—Å–∏ (proxy-groups, –ø—Ä–æ—Ñ–∏–ª—å: —Ä–æ—É—Ç–µ—Ä)</span>
                  <label class="checkbox-item" style="font-size: 12px;">
                    <input type="checkbox" id="selectAllRouterGroups" />
                    –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                  </label>
                </div>
                <div id="router-proxy-groups-list" class="checkbox-list"></div>
              </div>

              <div class="card router-rules-card">
                <div class="checkbox-group-header">
                  <span>–ü—Ä–∞–≤–∏–ª–∞ (—Ä–æ—É—Ç–µ—Ä Keenetic)</span>
                  <label class="checkbox-item" style="font-size: 12px;">
                    <input type="checkbox" id="selectAllRouterRules" />
                    –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                  </label>
                </div>
                <div id="router-rules-list" class="checkbox-list"></div>
              </div>
            </div>

            <div class="actions-row">
              <button class="btn" id="updatePreviewBtn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
              <button class="btn-primary btn" id="downloadBtn">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å config.yaml</button>
            </div>
          </div>

          <div class="tab-pane" id="tab-preview">
            <div class="card preview-area">
              <div class="preview-label-row">
                <span>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä config.yaml</span>
                <span class="chip" id="previewChip">–ü—Ä–æ—Ñ–∏–ª—å: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</span>
              </div>
              <pre class="preview" id="previewPre"><code id="previewCode"></code></pre>
              <!-- —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è/—Å–∫–∞—á–∏–≤–∞–Ω–∏—è -->
              <textarea id="previewArea" style="position:absolute;left:-9999px;top:-9999px;"></textarea>

              <div class="actions-row">
                <button class="btn" id="copyBtn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä</button>
                <button class="btn-primary btn" id="downloadBtn2">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å config.yaml</button>
              </div>
            </div>
          </div>
        </div>

        <div class="footer-note">
          –û—Ñ–ª–∞–π–Ω-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä (HTML + JavaScript). –ü—Ä–æ—Ñ–∏–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ –º–æ—Ç–∏–≤–∞–º artur.yaml, –ø—Ä–æ—Ñ–∏–ª—å —Ä–æ—É—Ç–µ—Ä–∞ ‚Äî Keenetic + zkeen.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // –ü–†–û–§–ò–õ–ò: app / router
    // ==========================
    let currentProfile = "app";

    const profileButtons = document.querySelectorAll(".profile-btn");
    const profileNote = document.getElementById("profileNote");
    const appSettingsBlock = document.getElementById("appSettingsBlock");
    const routerSettingsBlock = document.getElementById("routerSettingsBlock");
    const previewChip = document.getElementById("previewChip");
    const subsHint = document.getElementById("subsHint");

    profileButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const profile = btn.dataset.profile;
        if (!profile || profile === currentProfile) return;
        currentProfile = profile;

        profileButtons.forEach(b => b.classList.toggle("active", b.dataset.profile === profile));

        if (profile === "app") {
          appSettingsBlock.style.display = "";
          routerSettingsBlock.style.display = "none";
          profileNote.innerHTML =
            '–°–µ–π—á–∞—Å –≤—ã–±—Ä–∞–Ω –ø—Ä–æ—Ñ–∏–ª—å <strong>–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</strong> (Mihomo / Clash Meta –Ω–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–µ –∏–ª–∏ –ü–ö). ' +
            '–≠—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å <strong>–Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç</strong> –¥–ª—è –ø—Ä—è–º–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ.';
          previewChip.textContent = "–ü—Ä–æ—Ñ–∏–ª—å: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ";
          subsHint.textContent =
            "–î–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Ä–æ—É—Ç–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫/VLESS. –í —Ä–µ–∂–∏–º–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤–∫–ª—é—á–∞—é—Ç—Å—è –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã –∏ –ø—Ä–∞–≤–∏–ª–∞.";
        } else {
          appSettingsBlock.style.display = "none";
          routerSettingsBlock.style.display = "";
          profileNote.innerHTML =
            '–°–µ–π—á–∞—Å –≤—ã–±—Ä–∞–Ω –ø—Ä–æ—Ñ–∏–ª—å <strong>—Ä–æ—É—Ç–µ—Ä–∞ Keenetic (zkeen)</strong>. ' +
            '–≠—Ç–æ—Ç –∫–æ–Ω—Ñ–∏–≥ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–∞ —Ä–∞–±–æ—Ç—É –≤ –ø—Ä–æ—à–∏–≤–∫–µ —Ä–æ—É—Ç–µ—Ä–∞ –∏ –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.';
          previewChip.textContent = "–ü—Ä–æ—Ñ–∏–ª—å: —Ä–æ—É—Ç–µ—Ä Keenetic (zkeen)";
          subsHint.textContent =
            "–°—Å—ã–ª–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫/VLESS –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –≤ –∫–æ–Ω—Ñ–∏–≥–µ –¥–ª—è —Ä–æ—É—Ç–µ—Ä–∞ Keenetic. –ì—Ä—É–ø–ø—ã –∏ –ø—Ä–∞–≤–∏–ª–∞ —É–∂–µ –∑–∞—à–∏—Ç—ã –≤ —à–∞–±–ª–æ–Ω, –∞ –≤–∫–ª—é—á–∞–µ–º—ã–µ –±–ª–æ–∫–∏ –ø—Ä–∞–≤–∏–ª –≤—ã–±–∏—Ä–∞—é—Ç—Å—è —á–µ–∫–±–æ–∫—Å–∞–º–∏.";
        }

        if (document.getElementById("tab-preview").classList.contains("active")) {
          refreshPreview();
        }
      });
    });

    // ==========================
    // –û–ë–©–ò–ï –≠–õ–ï–ú–ï–ù–¢–´ UI
    // ==========================
    const subsContainer = document.getElementById("subs-container");
    const previewArea = document.getElementById("previewArea");
    const previewPre = document.getElementById("previewPre");
    const previewCode = document.getElementById("previewCode");
    const updatePreviewBtn = document.getElementById("updatePreviewBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const downloadBtn2 = document.getElementById("downloadBtn2");
    const copyBtn = document.getElementById("copyBtn");
    const themeToggle = document.getElementById("themeToggle");
    const themeLabelText = document.getElementById("themeLabelText");

    const selectAllGroups = document.getElementById("selectAllGroups");
    const selectAllRules = document.getElementById("selectAllRules");
    const proxyGroupsList = document.getElementById("proxy-groups-list");
    const rulesList = document.getElementById("rules-list");

    const selectAllRouterGroups = document.getElementById("selectAllRouterGroups");
    const selectAllRouterRules = document.getElementById("selectAllRouterRules");
    const routerProxyGroupsList = document.getElementById("router-proxy-groups-list");
    const routerRulesList = document.getElementById("router-rules-list");

    function initSubscriptions() {
      for (let i = 0; i < 5; i++) {
        const row = document.createElement("div");
        row.className = "sub-input-row";

        const lbl = document.createElement("label");
        lbl.textContent = (i + 1) + ".";
        row.appendChild(lbl);

        const inp = document.createElement("input");
        inp.type = "text";
        inp.placeholder = "https://... —Å—Å—ã–ª–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ / VLESS";
        inp.className = "sub-input";
        row.appendChild(inp);

        subsContainer.appendChild(row);
      }
    }

    function getCurrentState() {
      const subs = Array.from(document.querySelectorAll(".sub-input")).map(i => i.value);
      if (currentProfile === "app") {
        const enabledProxyGroups = Array.from(document.querySelectorAll(".cb-proxy-group"))
          .filter(cb => cb.checked)
          .map(cb => cb.dataset.name);
        const enabledRuleGroups = Array.from(document.querySelectorAll(".cb-rule-group"))
          .filter(cb => cb.checked)
          .map(cb => cb.dataset.name);
        const ipCheckEnabled = enabledRuleGroups.includes("IP Check via Proxy");
        return {
          profile: "app",
          subscriptions: subs,
          enabledProxyGroups,
          enabledRuleGroups,
          ipCheckEnabled,
        };
      } else {
        const enabledRouterProxyGroups = Array.from(document.querySelectorAll(".cb-router-proxy-group"))
          .filter(cb => cb.checked)
          .map(cb => cb.dataset.name);
        const enabledRouterRuleGroups = Array.from(document.querySelectorAll(".cb-router-rule"))
          .filter(cb => cb.checked)
          .map(cb => cb.dataset.key);
        return {
          profile: "router",
          subscriptions: subs,
          enabledRouterProxyGroups,
          enabledRouterRuleGroups,
        };
      }
    }

    // ==========================
    // –ü–†–û–§–ò–õ–¨ "–ü–†–ò–õ–û–ñ–ï–ù–ò–ï": —à–∞–±–ª–æ–Ω—ã
    // ==========================
    const APP_GLOBAL_HEADER = `port: 7890
socks-port: 7891

allow-lan: true
mode: rule
log-level: info
ipv6: true

unified-delay: true
tcp-concurrent: true
global-client-fingerprint: random

external-controller: "0.0.0.0:9090"
secret: "admin"
external-ui: ui
external-ui-url: "https://github.com/Zephyruso/zashboard/releases/latest/download/dist.zip"

profile:
  store-selected: true

sniffer:
  enable: true
  parse-pure-ip: true
  force-dns-mapping: true
  sniff:
    HTTP:
    TLS:
    QUIC:

`;

    const APP_PROXY_PROVIDERS_HEADER = "proxy-providers:\n";

    const APP_PROXY_PROVIDER_TEMPLATE = (name, url) => `  ${name}:
    type: http
    url: "${url}"
    path: ./proxy_providers/${name}.yaml
    interval: 3600
    health-check:
      enable: true
      url: "http://www.gstatic.com/generate_204"
      interval: 300
      timeout: 5000
      lazy: true
      expected-status: 204
    override:
      tfo: true
      mptcp: true
      udp: true

`;

    const APP_PROXY_GROUPS_HEADER = "# --------- –ì–†–£–ü–ü–´ –ü–†–û–ö–°–ò ---------\nproxy-groups:\n";

    const APP_PROXY_SELECTOR_TEMPLATE = useBlock => `  - name: Proxy-Selector
    type: url-test
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Rocket.png"
    use:${useBlock}
    url: "http://www.gstatic.com/generate_204"
    interval: 300
    tolerance: 50
    lazy: true

`;

    const APP_PROXY_GROUP_BLOCKS = {
      "Ru-Traffic": `  - name: Ru-Traffic
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Russia.png"
    proxies:
      - DIRECT
      - Proxy-Selector
    default: DIRECT

`,
      "META": `  - name: META
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Facebook.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector

`,
      "AMAZON": `  - name: AMAZON
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Amazon.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector

`,
      "FASTLY": `  - name: FASTLY
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector

`,
      "AKAMAI": `  - name: AKAMAI
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector

`,
      "GOOGLE": `  - name: GOOGLE
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Google.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector

`,
      "CLOUDFLARE": `  - name: CLOUDFLARE
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Cloudflare.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector

`,
      "CDN77": `  - name: CDN77
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector

`,
      "Telegram": `  - name: Telegram
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Telegram.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector

`,
      "Steam": `  - name: Steam
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Steam.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector

`,
      "Discord": `  - name: Discord
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Discord.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector

`,
      "YouTube": `  - name: YouTube
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/YouTube.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector

`,
      "AI-Dev": `  - name: AI-Dev
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/ChatGPT.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector

`,
      "Other-Domains": `  - name: Other-Domains
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Puzzle.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector

`,
      "Global-Default": `  - name: Global-Default
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Final.png"
    proxies:
      - DIRECT
      - Proxy-Selector
    default: DIRECT

`,
    };

    const APP_RULE_PROVIDERS_HEADER = "# --------- RULE-PROVIDERS ---------\nrule-providers:\n";

    const APP_RULE_PROVIDER_BLOCKS = {
      "CDN & Big Providers": `  akamai_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/akamai_ips.list"
    path: ./rule-sets/akamai_ips.list
    interval: 86400

  amazon_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/amazon_ips.list"
    path: ./rule-sets/amazon_ips.list
    interval: 86400

  cdn77_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/cdn77_ips.list"
    path: ./rule-sets/cdn77_ips.list
    interval: 86400

  cloudflare_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/cloudflare_ips.list"
    path: ./rule-sets/cloudflare_ips.list
    interval: 86400

  fastly_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/fastly_ips.list"
    path: ./rule-sets/fastly_ips.list
    interval: 86400

  google_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/google_ips.list"
    path: ./rule-sets/google_ips.list
    interval: 86400

  meta_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/meta_ips.list"
    path: ./rule-sets/meta_ips.list
    interval: 86400

`,
      "Other Domains": `  other_domains:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/other.list"
    path: ./rule-sets/other.list
    interval: 86400

`,
      "Telegram": `  telegram-ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/telegram_ips.list"
    path: ./rule-sets/telegram-ips.list
    interval: 86400

`,
      "Ru-Traffic": `  ru-ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/ru_ips.list"
    path: ./rule-sets/ru-ips.list
    interval: 86400

  ru-app-list:
    type: http
    behavior: classical
    format: yaml
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/other/ru-app-list.yaml"
    path: ./rule-sets/ru-app-list.yaml
    interval: 86400

`,
      "Discord": `  discord_voiceips:
    type: http
    behavior: ipcidr
    format: mrs
    url: "https://raw.githubusercontent.com/legiz-ru/mihomo-rule-sets/main/other/discord-voice-ip-list.mrs"
    path: ./rule-sets/discord_voice_ip_list.mrs
    interval: 86400

  discord_ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/discord_ips.list"
    path: ./rule-sets/discord_ips.list
    interval: 86400

  discord_domains:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/meta/geo/geosite/discord.mrs"
    path: ./rule-sets/discord_domains.mrs
    interval: 86400

`,
      "Steam": `  gaming-ips:
    type: http
    behavior: ipcidr
    format: yaml
    url: "https://raw.githubusercontent.com/OMchik33/custom-rules/main/mihomo/gaming-ips.yaml"
    path: ./rule-sets/gaming-ips.yaml
    interval: 86400

  steam-domain:
    type: http
    behavior: domain
    format: yaml
    url: "https://raw.githubusercontent.com/OMchik33/custom-rules/refs/heads/main/mihomo/gaming-domains.yaml"
    path: ./rule-sets/steam-domain.yaml
    interval: 86400

`,
      "YouTube": `  youtube-domains:
    type: http
    behavior: domain
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/youtube.list"
    path: ./rule-sets/youtube-domains.list
    interval: 86400

  youtube-ips:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251102-014123-835e3fe/youtube_ips.list"
    path: ./rule-sets/youtube-ips.list
    interval: 86400

`,
      "Extra Proxy Domains": `  extra-proxy-domains:
    type: http
    behavior: classical
    format: text
    url: "https://github.com/Anton111111/rule-lists/releases/download/lists-20251109-014029-835e3fe/domains.list"
    path: ./rule-sets/extra-proxy-domains.list
    interval: 86400

`,
      "AI / Dev": `  ai-dev-full:
    type: inline
    behavior: classical
    format: text
    payload:
      - DOMAIN-SUFFIX,githubcopilot.com
      - DOMAIN-SUFFIX,github.dev
      - DOMAIN-SUFFIX,github.com
      - DOMAIN-SUFFIX,githubusercontent.com
      - DOMAIN-SUFFIX,copilot-proxy.githubusercontent.com
      - DOMAIN-SUFFIX,telemetry.individual.githubcopilot.com
      - DOMAIN-SUFFIX,main.vscode-cdn.net
      - DOMAIN-SUFFIX,api.github.com
      - DOMAIN-SUFFIX,vscode.dev
      - DOMAIN-SUFFIX,api.individual.githubcopilot.com
      - DOMAIN-SUFFIX,marketplace.visualstudio.com
      - DOMAIN-SUFFIX,vscode-cdn.net
      - DOMAIN-SUFFIX,vscode.microsoft.com
      - DOMAIN-SUFFIX,code.visualstudio.com
      - DOMAIN-KEYWORD,copilot
      - DOMAIN-KEYWORD,vscode
      - DOMAIN-KEYWORD,github
      - DOMAIN-SUFFIX,copilot.microsoft.com
      - DOMAIN-SUFFIX,bing.com
      - DOMAIN-SUFFIX,microsoftcopilot.app
      - DOMAIN-SUFFIX,openai.com
      - DOMAIN-SUFFIX,api.openai.com
      - DOMAIN-SUFFIX,chat.openai.com
      - DOMAIN-SUFFIX,chatgpt.com
      - DOMAIN-SUFFIX,platform.openai.com
      - DOMAIN-KEYWORD,chatgpt
      - DOMAIN-SUFFIX,gemini.google.com
      - DOMAIN-SUFFIX,bard.google.com
      - DOMAIN-SUFFIX,ai.google.dev
      - DOMAIN-SUFFIX,aistudio.google.com
      - DOMAIN-SUFFIX,claude.ai
      - DOMAIN-SUFFIX,anthropic.com
      - DOMAIN-SUFFIX,x.ai
      - DOMAIN-SUFFIX,grok.x.ai
      - DOMAIN-SUFFIX,perplexity.ai
      - DOMAIN-SUFFIX,huggingface.co
      - DOMAIN-SUFFIX,midjourney.com
      - DOMAIN-SUFFIX,cdn.midjourney.com
      - DOMAIN-SUFFIX,stability.ai
      - DOMAIN-SUFFIX,runwayml.com
      - DOMAIN-SUFFIX,character.ai
      - DOMAIN-SUFFIX,replicate.com

`,
    };

    const APP_RULES_HEADER = "# --------- –ü–†–ê–í–ò–õ–ê ---------\nrules:\n";

    const APP_RULES_BASE_LOCAL = `  - IP-CIDR,192.168.0.0/16,DIRECT,no-resolve
  - IP-CIDR,10.0.0.0/8,DIRECT,no-resolve
  - IP-CIDR,172.16.0.0/12,DIRECT,no-resolve
  - IP-CIDR,127.0.0.0/8,DIRECT,no-resolve

`;

    const APP_RULE_BLOCKS = {
      "Steam": `  # Steam
  - RULE-SET,steam-domain,Steam
  - RULE-SET,gaming-ips,Steam
  - DST-PORT,3659,Steam
  - DST-PORT,14000-14016,Steam
  - DST-PORT,18000,Steam
  - DST-PORT,20000-26000,Steam
  - DST-PORT,21000-21500,Steam
  - DST-PORT,23000-24000,Steam
  - DST-PORT,27015,Steam
  - DST-PORT,27031-27036,Steam
  - DST-PORT,27036,Steam

`,
      "Discord": `  # Discord
  - RULE-SET,discord_domains,Discord
  - RULE-SET,discord_ips,Discord
  - RULE-SET,discord_voiceips,Discord
  - DST-PORT,3478-3480,Discord
  - DST-PORT,5222-5223,Discord
  - DST-PORT,5228,Discord
  - DST-PORT,5242,Discord
  - DST-PORT,50000-50100,Discord

`,
      "YouTube": `  # YouTube
  - RULE-SET,youtube-domains,YouTube
  - RULE-SET,youtube-ips,YouTube

`,
      "CDN & Big Providers": `  # CDN
  - RULE-SET,akamai_ips,AKAMAI
  - RULE-SET,amazon_ips,AMAZON
  - RULE-SET,fastly_ips,FASTLY
  - RULE-SET,google_ips,GOOGLE
  - RULE-SET,cloudflare_ips,CLOUDFLARE
  - RULE-SET,cdn77_ips,CDN77
  - RULE-SET,meta_ips,META

`,
      "Telegram": `  # Telegram
  - RULE-SET,telegram-ips,Telegram

`,
      "Ru-Traffic": `  # Russian apps/traffic
  - RULE-SET,ru-app-list,Ru-Traffic
  - RULE-SET,ru-ips,Ru-Traffic

`,
      "Extra Proxy Domains": `  # Extra proxy domains
  - RULE-SET,extra-proxy-domains,Proxy-Selector

`,
      "AI / Dev": `  # AI / Dev
  - RULE-SET,ai-dev-full,AI-Dev

`,
      "Other Domains": `  # Other
  - RULE-SET,other_domains,Other-Domains

`,
      "IP Check via Proxy": `  # IP check ‚Äî through proxy
  - DOMAIN,ipwho.is,Proxy-Selector
  - DOMAIN,api.ip.sb,Proxy-Selector
  - DOMAIN,ipapi.co,Proxy-Selector
  - DOMAIN,ipinfo.io,Proxy-Selector
  - DOMAIN,2ip.io,Proxy-Selector
  - DOMAIN,2ip.ru,Proxy-Selector

`,
    };

    const APP_RULES_FOOTER = "  - MATCH,Global-Default\n";

    function appBuildProxyProviders(urls) {
      const clean = urls.map(u => u.trim()).filter(Boolean);
      if (!clean.length) return "";
      let out = APP_PROXY_PROVIDERS_HEADER;
      clean.forEach((url, idx) => {
        const name = `my-vless-sub-${idx + 1}`;
        out += APP_PROXY_PROVIDER_TEMPLATE(name, url);
      });
      out += "\n";
      return out;
    }

    function appBuildProxyGroups(enabledGroupNames, providerCount) {
      let out = APP_PROXY_GROUPS_HEADER;
      let useLines = "";
      if (providerCount > 0) {
        for (let i = 1; i <= providerCount; i++) {
          useLines += `\n      - my-vless-sub-${i}`;
        }
      }
      out += APP_PROXY_SELECTOR_TEMPLATE(useLines);

      enabledGroupNames.forEach(name => {
        const block = APP_PROXY_GROUP_BLOCKS[name];
        if (block) out += block;
      });

      out += "\n";
      return out;
    }

    function appBuildRuleProviders(enabledRuleGroups) {
      const names = enabledRuleGroups.filter(n => n !== "IP Check via Proxy");
      if (!names.length) return "";
      let out = APP_RULE_PROVIDERS_HEADER;
      const added = new Set();
      names.forEach(name => {
        if (!added.has(name) && APP_RULE_PROVIDER_BLOCKS[name]) {
          out += APP_RULE_PROVIDER_BLOCKS[name];
          added.add(name);
        }
      });
      out += "\n";
      return out;
    }

    function appBuildRules(enabledRuleGroups) {
      let out = APP_RULES_HEADER + APP_RULES_BASE_LOCAL;
      enabledRuleGroups.forEach(name => {
        const block = APP_RULE_BLOCKS[name];
        if (block) out += block;
      });
      out += APP_RULES_FOOTER;
      return out;
    }

    function buildAppConfig(state) {
      const subs = state.subscriptions.map(x => x.trim()).filter(Boolean).slice(0, 5);
      let cfg = APP_GLOBAL_HEADER;
      cfg += appBuildProxyProviders(subs);
      cfg += appBuildProxyGroups(state.enabledProxyGroups, subs.length);
      cfg += appBuildRuleProviders(state.enabledRuleGroups);
      let ruleGroups = state.enabledRuleGroups.slice();
      if (state.ipCheckEnabled && !ruleGroups.includes("IP Check via Proxy")) {
        ruleGroups.push("IP Check via Proxy");
      }
      cfg += appBuildRules(ruleGroups);
      return cfg;
    }

    // ==========================
    // –ü–†–û–§–ò–õ–¨ "–†–û–£–¢–ï–†": —à–∞–±–ª–æ–Ω—ã
    // ==========================
    const ROUTER_GLOBAL_HEADER = `# =============================================================
# Mihomo / Clash Meta ‚Äî –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è —Ä–æ—É—Ç–µ—Ä–∞ Keenetic
# DNS —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ä–æ—É—Ç–µ—Ä–æ–º (—Å–µ–∫—Ü–∏—è dns: –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
# –ì–µ–æ–¥–∞–Ω–Ω—ã–µ: zkeen (geosite / geoip)
# =============================================================

redir-port: 1182
tproxy-port: 1181
mixed-port: 1080
allow-lan: true
log-level: silent
geodata-mode: true
geo-auto-update: true
geo-update-interval: 72
find-process-mode: off
ipv6: false

external-controller: "0.0.0.0:9090"
secret: "admin"
external-ui: ui
external-ui-url: "https://github.com/Zephyruso/zashboard/releases/download/v2.1.0/dist-no-fonts.zip"

profile:
  store-selected: true

sniffer:
  enable: true
  parse-pure-ip: true
  sniff:
    HTTP:
    TLS:
    QUIC:

# –ì–µ–æ–¥–∞–Ω–Ω—ã–µ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è GEOSITE / GEOIP-–ø—Ä–∞–≤–∏–ª–∞–º–∏)
geox-url:
  geosite: "https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat"
  geoip:   "https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat"

# =============================================================
# 1. PROXY PROVIDERS (–ü–û–î–ü–ò–°–ö–ò)
# =============================================================
`;

    const ROUTER_PROXY_PROVIDERS_HEADER = "proxy-providers:\n\n";
    const ROUTER_PROVIDER_NAMES = [
      "my-vless-sub",
      "second-sub",
      "third-sub",
      "fourth-sub",
      "fifth-sub",
    ];

    function routerProviderTemplate(name, url) {
      return `  ${name}:
    type: http
    url: ${JSON.stringify(url)}
    path: ./proxy_providers/${name}.yaml
    interval: 3600
    health-check:
      enable: true
      url: http://www.gstatic.com/generate_204
      interval: 300
      timeout: 8000
      lazy: true
      expected-status: 204
    override:
      tfo: true
      mptcp: true
      udp: true

`;
    }

    function routerBuildProxyProviders(urls) {
      const clean = urls.map(x => x.trim()).filter(Boolean).slice(0, 5);
      let out = ROUTER_PROXY_PROVIDERS_HEADER;
      if (!clean.length) {
        out += "  # —Å—é–¥–∞ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–¥–ø–∏—Å–∫—É\n\n";
        return out;
      }
      clean.forEach((url, idx) => {
        const name = ROUTER_PROVIDER_NAMES[idx] || `sub-${idx + 1}`;
        out += routerProviderTemplate(name, url);
      });
      out += "\n";
      return out;
    }

    function routerBuildProxyGroups(subCount) {
      let useLines = "";
      for (let i = 0; i < subCount && i < ROUTER_PROVIDER_NAMES.length; i++) {
        useLines += `\n      - ${ROUTER_PROVIDER_NAMES[i]}`;
      }
      const useBlock = useLines || "";

      const block = `# =============================================================
# 2. PROXY GROUPS (–ì–†–£–ü–ü–´)
# =============================================================
proxy-groups:

  # –ê–≤—Ç–æ–≤—ã–±–æ—Ä –ª—É—á—à–µ–≥–æ —É–∑–ª–∞ –ø–æ –∑–∞–¥–µ—Ä–∂–∫–µ
  - name: Auto-VPN
    type: url-test
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Rocket.png"
    use:${useBlock}
    url: "http://www.gstatic.com/generate_204"
    interval: 300
    tolerance: 50
    lazy: true

  # –û—Å–Ω–æ–≤–Ω–∞—è –≥—Ä—É–ø–ø–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
  - name: Proxy-Selector
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Proxy.png"
    use:${useBlock}
    proxies:
      - Auto-VPN
      - DIRECT
    default: DIRECT

  - name: DOMAINS
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Puzzle.png"
    proxies:
      - Proxy-Selector
      - DIRECT

  - name: OTHER
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - Proxy-Selector
      - DIRECT

  - name: Ru-Traffic
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Russia.png"
    use:${useBlock}
    proxies:
      - DIRECT
      - Proxy-Selector
    default: DIRECT

  - name: Ad-Filter
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/AdBlack.png"
    proxies:
      - REJECT
      - DIRECT
    default: REJECT

  - name: ECH-Refilter
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Direct.png"
    proxies:
      - Proxy-Selector
      - DIRECT
    default: Proxy-Selector

  - name: META
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Facebook.png"
    proxies:
      - Proxy-Selector
      - DIRECT

  - name: AMAZON
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Amazon.png"
    proxies:
      - Proxy-Selector
      - DIRECT

  - name: FASTLY
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - Proxy-Selector
      - DIRECT

  - name: AKAMAI
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - Proxy-Selector
      - DIRECT

  - name: GOOGLE
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Google.png"
    proxies:
      - Proxy-Selector
      - DIRECT

  - name: CLOUDFLARE
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Cloudflare.png"
    proxies:
      - DIRECT
      - Proxy-Selector

  - name: CDN77
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - DIRECT
      - Proxy-Selector

  - name: DIGITALOCEAN
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - DIRECT
      - Proxy-Selector

  - name: HETZNER
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - DIRECT
      - Proxy-Selector

  - name: GCORE
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - DIRECT
      - Proxy-Selector

  - name: LINODE
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - DIRECT
      - Proxy-Selector

  - name: MEGA
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - DIRECT
      - Proxy-Selector

  - name: ORACLE
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - DIRECT
      - Proxy-Selector

  - name: OVH
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - DIRECT
      - Proxy-Selector

  - name: VULTR
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    proxies:
      - DIRECT
      - Proxy-Selector

  - name: Telegram
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Telegram.png"
    proxies:
      - Proxy-Selector
      - DIRECT

  - name: Discord
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Discord.png"
    proxies:
      - Proxy-Selector
      - DIRECT

  - name: Steam
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Steam.png"
    proxies:
      - Proxy-Selector
      - DIRECT

  - name: YouTube
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/YouTube.png"
    use:${useBlock}
    proxies:
      - Proxy-Selector
    default: Proxy-Selector

  - name: Torrent-Traffic
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Download.png"
    proxies:
      - DIRECT
      - Proxy-Selector

  - name: POLITIC
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Media.png"
    proxies:
      - DIRECT
      - Proxy-Selector

  - name: Global-Default
    type: select
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Final.png"
    proxies:
      - DIRECT
      - Proxy-Selector

`;

      return block + "\n";
    }

    const ROUTER_RULE_PROVIDERS_BLOCK = `# =============================================================
# 3. RULE PROVIDERS
# =============================================================
rule-providers:

  discord_voiceips:
    type: http
    behavior: ipcidr
    format: mrs
    url: "https://raw.githubusercontent.com/legiz-ru/mihomo-rule-sets/main/other/discord-voice-ip-list.mrs"
    path: ./rule-sets/discord-voice-ip-list.mrs
    interval: 86400

  discord_domains:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/meta/geo/geosite/discord.mrs"
    path: ./rule-sets/discord_domains.mrs
    interval: 86400

  gaming-ips:
    type: http
    behavior: ipcidr
    format: yaml
    url: "https://raw.githubusercontent.com/OMchik33/custom-rules/main/mihomo/gaming-ips.yaml"
    path: ./rule-sets/gaming-ips.yaml
    interval: 86400

  ru-app-list:
    type: http
    behavior: classical
    format: yaml
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/other/ru-app-list.yaml"
    path: ./rule-sets/ru-app-list.yaml
    interval: 86400

  steam-domain:
    type: http
    behavior: domain
    format: yaml
    url: "https://raw.githubusercontent.com/OMchik33/custom-rules/refs/heads/main/mihomo/gaming-domains.yaml"
    path: ./rule-sets/steam-domain.yaml
    interval: 86400

  refilter_noech:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/re-filter/re-filter-noech.mrs"
    path: ./re-filter/noech.mrs
    interval: 86400

  refilter_ech:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/re-filter/re-filter-ech.mrs"
    path: ./re-filter/ech.mrs
    interval: 86400

  refilter_ipsum:
    type: http
    behavior: ipcidr
    format: mrs
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/re-filter/ip-rule.mrs"
    path: ./re-filter/ip-rule.mrs
    interval: 86400

  torrent-clients:
    type: http
    behavior: classical
    format: yaml
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/other/torrent-clients.yaml"
    path: ./rule-sets/torrent-clients.yaml
    interval: 86400

  torrent-trackers:
    type: http
    behavior: domain
    format: mrs
    url: "https://raw.githubusercontent.com/legiz-ru/mihomo-rule-sets/main/other/torrent-trackers.mrs"
    path: ./rule-sets/torrent-trackers.mrs
    interval: 86400

  torrent-websites:
    type: http
    behavior: domain
    format: mrs
    url: "https://raw.githubusercontent.com/legiz-ru/mihomo-rule-sets/main/other/torrent-websites.mrs"
    path: ./rule-sets/torrent-websites.mrs
    interval: 86400

  oisd_big:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/oisd/big.mrs"
    path: ./oisd/big.mrs
    interval: 86400

  oisd_small:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/oisd/small.mrs"
    path: ./oisd/small.mrs
    interval: 86400

  oisd_nsfw_small:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/oisd/nsfw_small.mrs"
    path: ./oisd/nsfw_small.mrs
    interval: 86400

  oisd_nsfw_big:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/legiz-ru/mihomo-rule-sets/raw/main/oisd/nsfw.mrs"
    path: ./oisd/nsfw_big.mrs
    interval: 86400

`;

    const ROUTER_RULES_HEADER = `# =============================================================
# 4. RULES
# =============================================================
rules:

  # –õ–æ–∫–∞–ª—å–Ω–∞—è —Å–µ—Ç—å –∏ DNS –≤ –æ–±—Ö–æ–¥ –ø—Ä–æ–∫—Å–∏
  - IP-CIDR,192.168.0.0/16,DIRECT,no-resolve
  - IP-CIDR,10.0.0.0/8,DIRECT,no-resolve
  - IP-CIDR,172.16.0.0/12,DIRECT,no-resolve
  - IP-CIDR,127.0.0.0/8,DIRECT,no-resolve
  - DST-PORT,53,DIRECT

  # IP-—á–µ–∫–µ—Ä—ã ‚Äî –≤—Å–µ–≥–¥–∞ —á–µ—Ä–µ–∑ VPN (Proxy-Selector)
  - OR,((DOMAIN,ipwho.is),(DOMAIN,api.ip.sb),(DOMAIN,ipapi.co),(DOMAIN,ipinfo.io),(DOMAIN,2ip.io),(DOMAIN,2ip.ru)),Proxy-Selector

`;

    const ROUTER_RULE_BLOCKS = {
      "Ad-Filter": `  # –†–µ–∫–ª–∞–º–∞ / NSFW (oisd ‚Äî —Ä–µ–∂–µ–º –≤ Ad-Filter)
  - RULE-SET,oisd_small,Ad-Filter
  - RULE-SET,oisd_big,Ad-Filter
  - RULE-SET,oisd_nsfw_small,Ad-Filter
  - RULE-SET,oisd_nsfw_big,Ad-Filter

`,
      "GamesMedia": `  # Discord ‚Äî –¥–æ–º–µ–Ω—ã, GEOIP, –≥–æ–ª–æ—Å, STUN/WebRTC –∏ –¥–∏–∞–ø–∞–∑–æ–Ω—ã –ø–æ—Ä—Ç–æ–≤
  - OR,((RULE-SET,discord_domains),(GEOIP,DISCORD),(RULE-SET,discord_voiceips),(DST-PORT,3478-3480),(DST-PORT,5222-5223),(DST-PORT,5228),(DST-PORT,5242),(DST-PORT,50000-50100)),Discord

  # Steam –∏ –æ–±—â–∏–π –∏–≥—Ä–æ–≤–æ–π —Ç—Ä–∞—Ñ–∏–∫ ‚Äî –¥–æ–º–µ–Ω—ã, IP-—Å–µ—Ç–∏, –∏–≥—Ä–æ–≤—ã–µ –ø–æ—Ä—Ç—ã
  - OR,((RULE-SET,steam-domain),(RULE-SET,gaming-ips),(DST-PORT,3659),(DST-PORT,14000-14016),(DST-PORT,18000),(DST-PORT,20000-26000),(DST-PORT,21000-21500),(DST-PORT,23000-24000),(DST-PORT,27015),(DST-PORT,27031-27036),(DST-PORT,27036)),Steam

  # YouTube ‚Äî —Å—Ç—Ä–∏–º–∏–Ω–≥/–≤–∏–¥–µ–æ–∫–æ–Ω—Ç–µ–Ω—Ç
  - OR,((GEOSITE,YOUTUBE),(GEOIP,YOUTUBE)),YouTube

  # Telegram
  - GEOIP,TELEGRAM,Telegram

`,
      "CDN_DC": `  # –ò–≥—Ä–æ–≤—ã–µ CDN / –¥–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä—ã
  - GEOIP,AKAMAI,AKAMAI
  - GEOIP,AMAZON,AMAZON
  - GEOIP,CDN77,CDN77
  - GEOIP,CLOUDFLARE,CLOUDFLARE
  - GEOIP,DIGITALOCEAN,DIGITALOCEAN
  - GEOIP,FASTLY,FASTLY
  - GEOIP,GCORE,GCORE
  - GEOIP,HETZNER,HETZNER
  - GEOIP,LINODE,LINODE
  - GEOIP,ORACLE,ORACLE
  - GEOIP,OVH,OVH
  - GEOIP,VULTR,VULTR
  - GEOIP,META,META

`,
      "Torrent": `  # –¢–æ—Ä—Ä–µ–Ω—Ç—ã
  - OR,((RULE-SET,torrent-clients),(RULE-SET,torrent-trackers)),Torrent-Traffic
  - RULE-SET,torrent-websites,Torrent-Traffic

`,
      "Ru": `  # –†–æ—Å—Å–∏–π—Å–∫–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ IP-—Å–µ—Ç–∏
  - RULE-SET,ru-app-list,Ru-Traffic
  - GEOIP,RU,Ru-Traffic

`,
      "Refilter": `  # Re-filter / ECH
  - RULE-SET,refilter_ech,ECH-Refilter
  - RULE-SET,refilter_noech,ECH-Refilter
  - RULE-SET,refilter_ipsum,ECH-Refilter

`,
      "GeoSite": `  # –û—Å–Ω–æ–≤–Ω—ã–µ GeoSite-–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –ø–æ –¥–æ–º–µ–Ω–Ω—ã–º —Å–ø–∏—Å–∫–∞–º)
  - GEOSITE,DOMAINS,DOMAINS
  - GEOSITE,OTHER,OTHER
  - GEOSITE,POLITIC,POLITIC

`,
    };

    const ROUTER_RULES_FOOTER = "  # –§–∏–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ ‚Äî –≤—Å—ë, —á—Ç–æ –Ω–µ –º–∞—Ç—á–Ω—É–ª–æ—Å—å –≤—ã—à–µ\n  - MATCH,Global-Default\n";

    const routerRuleDefs = [
      { label: "Ad-Filter (OISD —Ä–µ–∫–ª–∞–º–∞/NSFW)", key: "Ad-Filter" },
      { label: "–ò–≥—Ä—ã / –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã / –º–µ–¥–∏–∞ (Discord, Steam, YouTube, Telegram)", key: "GamesMedia" },
      { label: "CDN –∏ –¥–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä—ã (AKAMAI, LINODE, GCORE, ...)", key: "CDN_DC" },
      { label: "Torrent-Traffic (–∫–ª–∏–µ–Ω—Ç—ã, —Ç—Ä—ç–∫–µ—Ä, —Å–∞–π—Ç—ã)", key: "Torrent" },
      { label: "Ru-Traffic (RU GEOIP + –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)", key: "Ru" },
      { label: "Re-filter / ECH (—Ä–µ—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è)", key: "Refilter" },
      { label: "GeoSite DOMAINS / OTHER / POLITIC", key: "GeoSite" },
    ];

    function buildRouterRules(enabledKeys) {
      const keys = (enabledKeys && enabledKeys.length) ? enabledKeys : routerRuleDefs.map(d => d.key);
      let out = ROUTER_RULES_HEADER;
      keys.forEach(k => {
        if (ROUTER_RULE_BLOCKS[k]) out += ROUTER_RULE_BLOCKS[k];
      });
      out += ROUTER_RULES_FOOTER;
      return out;
    }

    function buildRouterConfig(state) {
      const subs = state.subscriptions.map(x => x.trim()).filter(Boolean).slice(0, 5);
      let cfg = ROUTER_GLOBAL_HEADER;
      cfg += routerBuildProxyProviders(subs);
      cfg += routerBuildProxyGroups(subs.length || 1);
      cfg += ROUTER_RULE_PROVIDERS_BLOCK + "\n";
      cfg += buildRouterRules(state.enabledRouterRuleGroups || []);
      return cfg;
    }

    // ==========================
    // –û–ë–©–ê–Ø –°–ë–û–†–ö–ê
    // ==========================
    function buildFullConfig(state) {
      if (state.profile === "router") {
        return buildRouterConfig(state);
      } else {
        return buildAppConfig(state);
      }
    }

    // ==========================
    // –ü–û–î–°–í–ï–¢–ö–ê YAML
    // ==========================
    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function highlightYaml(yaml) {
      const lines = yaml.split("\n");
      return lines.map(line => {
        const trimmed = line.trim();
        if (trimmed.startsWith("#")) {
          return `<span class="yaml-comment">${escapeHtml(line)}</span>`;
        }
        let main = line;
        let comment = "";
        const hashPos = line.indexOf("#");
        if (hashPos !== -1) {
          main = line.slice(0, hashPos);
          comment = line.slice(hashPos);
        }
        const commentHtml = comment ? `<span class="yaml-comment">${escapeHtml(comment)}</span>` : "";

        const keyMatch = /^(\s*)([^:#]+?)(:)(.*)$/.exec(main);
        if (keyMatch) {
          const indent = keyMatch[1] || "";
          const key = keyMatch[2] || "";
          const colon = keyMatch[3] || ":";
          const rest = keyMatch[4] || "";
          const keyHtml =
            `${escapeHtml(indent)}<span class="yaml-key">${escapeHtml(key.trim())}</span>${escapeHtml(colon)}`;
          const restHtml = escapeHtml(rest);
          return keyHtml + restHtml + commentHtml;
        } else {
          return escapeHtml(line);
        }
      }).join("\n");
    }

    function refreshPreview() {
      const state = getCurrentState();
      const yaml = buildFullConfig(state);
      previewArea.value = yaml;
      previewCode.innerHTML = highlightYaml(yaml);
    }

    function downloadConfig() {
      const yaml = previewArea.value || buildFullConfig(getCurrentState());
      const blob = new Blob([yaml], { type: "text/yaml;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "config.yaml";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ==========================
    // –ß–ï–ö–ë–û–ö–°–´ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    // ==========================
    const proxyGroupNamesOrder = [
      "Ru-Traffic",
      "META",
      "AMAZON",
      "FASTLY",
      "AKAMAI",
      "GOOGLE",
      "CLOUDFLARE",
      "CDN77",
      "Telegram",
      "Steam",
      "Discord",
      "YouTube",
      "AI-Dev",
      "Other-Domains",
      "Global-Default",
    ];


    // –ì—Ä—É–ø–ø—ã –ø—Ä–æ–∫—Å–∏ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è —Ä–æ—É—Ç–µ—Ä–∞ (–≤—Å–µ –∏–∑ —à–∞–±–ª–æ–Ω–∞, –∫—Ä–æ–º–µ Global-Default –≤ —á–µ–∫–±–æ–∫—Å–∞—Ö)
    const routerProxyGroupNamesOrder = [
      "Auto-VPN",
      "Proxy-Selector",
      "DOMAINS",
      "OTHER",
      "Ru-Traffic",
      "Ad-Filter",
      "ECH-Refilter",
      "META",
      "AMAZON",
      "FASTLY",
      "AKAMAI",
      "GOOGLE",
      "CLOUDFLARE",
      "CDN77",
      "DIGITALOCEAN",
      "HETZNER",
      "GCORE",
      "LINODE",
      "MEGA",
      "ORACLE",
      "OVH",
      "VULTR",
      "Telegram",
      "Discord",
      "Steam",
      "YouTube",
      "Torrent-Traffic",
      "POLITIC",
      "Global-Default",
    ];

    const ruleNamesOrder = [
      "Steam",
      "Discord",
      "YouTube",
      "CDN & Big Providers",
      "Telegram",
      "Ru-Traffic",
      "Extra Proxy Domains",
      "AI / Dev",
      "Other Domains",
      "IP Check via Proxy",
    ];

    function initProxyGroups() {
      proxyGroupNamesOrder.forEach(name => {
        const wrap = document.createElement("label");
        wrap.className = "checkbox-item";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "cb-proxy-group";
        cb.dataset.name = name;
        cb.checked = true;
        const span = document.createElement("span");
        span.textContent = name;
        wrap.appendChild(cb);
        wrap.appendChild(span);
        proxyGroupsList.appendChild(wrap);
      });
    }

    function initRules() {
      ruleNamesOrder.forEach(name => {
        const wrap = document.createElement("label");
        wrap.className = "checkbox-item";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "cb-rule-group";
        cb.dataset.name = name;
        cb.checked = true;
        const span = document.createElement("span");
        span.textContent = name;
        wrap.appendChild(cb);
        wrap.appendChild(span);
        rulesList.appendChild(wrap);
      });
    }


    selectAllGroups.addEventListener("change", () => {
      const checked = selectAllGroups.checked;
      document.querySelectorAll(".cb-proxy-group").forEach(cb => cb.checked = checked);
      if (currentProfile === "app" && document.getElementById("tab-preview").classList.contains("active")) {
        refreshPreview();
      }
    });

    selectAllRules.addEventListener("change", () => {
      const checked = selectAllRules.checked;
      document.querySelectorAll(".cb-rule-group").forEach(cb => cb.checked = checked);
      if (currentProfile === "app" && document.getElementById("tab-preview").classList.contains("active")) {
        refreshPreview();
      }
    });

    selectAllRouterGroups.addEventListener("change", () => {
      const checked = selectAllRouterGroups.checked;
      document.querySelectorAll(".cb-router-proxy-group").forEach(cb => cb.checked = checked);
      if (currentProfile === "router" && document.getElementById("tab-preview").classList.contains("active")) {
        refreshPreview();
      }
    });

    selectAllRouterRules.addEventListener("change", () => {
      const checked = selectAllRouterRules.checked;
      document.querySelectorAll(".cb-router-rule").forEach(cb => cb.checked = checked);
      if (currentProfile === "router" && document.getElementById("tab-preview").classList.contains("active")) {
        refreshPreview();
      }
    });

    document.addEventListener("change", e => {
      if (
        e.target.classList.contains("cb-proxy-group") ||
        e.target.classList.contains("cb-rule-group") ||
        e.target.classList.contains("cb-router-proxy-group") ||
        e.target.classList.contains("cb-router-rule") ||
        e.target.classList.contains("sub-input")
      ) {
        if (document.getElementById("tab-preview").classList.contains("active")) {
          refreshPreview();
        }
      }
    });

    // ==========================
    // –¢–ê–ë–´
    // ==========================
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll(".tab-pane").forEach(p => {
          p.classList.toggle("active", p.id === "tab-" + tab);
        });
        if (tab === "preview") refreshPreview();
      });
    });

    // ==========================
    // –ö–ù–û–ü–ö–ò
    // ==========================
    updatePreviewBtn.addEventListener("click", refreshPreview);
    downloadBtn.addEventListener("click", () => {
      refreshPreview();
      downloadConfig();
    });
    downloadBtn2.addEventListener("click", () => {
      refreshPreview();
      downloadConfig();
    });

    async function copyPreviewToClipboard() {
      const textVal = previewArea.value || "";
      if (!textVal) return;

      // –û—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å: Clipboard API
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(textVal);
          copyBtn.textContent = "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ";
          setTimeout(() => { copyBtn.textContent = "üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä"; }, 1400);
          return;
        }
      } catch (e) {
        console.warn("Clipboard API error, fallback to execCommand:", e);
      }

      // –§–æ–ª–±—ç–∫: document.execCommand('copy') –¥–ª—è file://, content:// –∏ —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
      try {
        const temp = document.createElement("textarea");
        temp.value = textVal;
        temp.style.position = "fixed";
        temp.style.top = "-9999px";
        temp.style.left = "-9999px";
        temp.setAttribute("readonly", "");
        document.body.appendChild(temp);
        temp.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(temp);
        if (ok) {
          copyBtn.textContent = "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ";
          setTimeout(() => { copyBtn.textContent = "üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä"; }, 1400);
        } else {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å: –æ–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –±—Ä–∞—É–∑–µ—Ä–æ–º.");
        }
      } catch (e2) {
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞): " + e2);
      }
    }

    copyBtn.addEventListener("click", () => {
      copyPreviewToClipboard();
    });

    // ==========================
    // –¢–ï–ú–ê
    // ==========================
    function applyThemeFromStorage() {
      const saved = localStorage.getItem("mihomo-universal-theme");
      if (saved === "dark") {
        document.body.classList.add("dark");
        themeToggle.checked = true;
        themeLabelText.textContent = "–¢—ë–º–Ω–∞—è";
      } else {
        document.body.classList.remove("dark");
        themeToggle.checked = false;
        themeLabelText.textContent = "–°–≤–µ—Ç–ª–∞—è";
      }
    }
    applyThemeFromStorage();

    themeToggle.addEventListener("change", () => {
      if (themeToggle.checked) {
        document.body.classList.add("dark");
        themeLabelText.textContent = "–¢—ë–º–Ω–∞—è";
        localStorage.setItem("mihomo-universal-theme", "dark");
      } else {
        document.body.classList.remove("dark");
        themeLabelText.textContent = "–°–≤–µ—Ç–ª–∞—è";
        localStorage.setItem("mihomo-universal-theme", "light");
      }
    });

    // ==========================
    // –°–¢–ê–†–¢
    // ==========================
    
    // =========================================================
    // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê: –≥—Ä—É–ø–ø—ã ‚Üî –ø—Ä–∞–≤–∏–ª–∞, —É–∑–ª—ã / –ø–æ–¥–ø–∏—Å–∫–∏
    // =========================================================

    // –°–≤—è–∑–∫–∞ –≥—Ä—É–ø–ø –ø—Ä–æ–∫—Å–∏ –∏ rule-–≥—Ä—É–ø–ø –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    const groupToRules = {
      "Steam": ["Steam"],
      "Discord": ["Discord"],
      "YouTube": ["YouTube"],
      "Telegram": ["Telegram"],
      "Ru-Traffic": ["Ru-Traffic"],
      "AI-Dev": ["AI / Dev"],
      "Other-Domains": ["Other Domains"],
      "META": ["CDN & Big Providers"],
      "AMAZON": ["CDN & Big Providers"],
      "FASTLY": ["CDN & Big Providers"],
      "AKAMAI": ["CDN & Big Providers"],
      "GOOGLE": ["CDN & Big Providers"],
      "CLOUDFLARE": ["CDN & Big Providers"],
      "CDN77": ["CDN & Big Providers"],
    };

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ rule-–≥—Ä—É–ø–ø—ã, –∫–æ—Ç–æ—Ä—ã–µ –∂—ë—Å—Ç–∫–æ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –≥—Ä—É–ø–ø–∞–º –ø—Ä–æ–∫—Å–∏
    const autoRuleNamesSet = new Set();
    Object.keys(groupToRules).forEach(groupName => {
      const rules = groupToRules[groupName] || [];
      rules.forEach(ruleName => autoRuleNamesSet.add(ruleName));
    });

    // –í –±–ª–æ–∫–µ "–ü—Ä–∞–≤–∏–ª–∞" –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ rule-–≥—Ä—É–ø–ø—ã,
    // –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø –ø—Ä–æ–∫—Å–∏
    const visibleRuleNamesOrder = ruleNamesOrder.filter(name => !autoRuleNamesSet.has(name));

    // –ö–∞–∫–∏–µ –≥—Ä—É–ø–ø—ã –≤–∫–ª—é—á–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –ø—Ä–æ—Ñ–∏–ª–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    const defaultProxyGroupsApp = [
      "Ru-Traffic",
      "Discord",
      "META",
      "YouTube",
      "Telegram",
      "AMAZON",
      "Other-Domains",
    ];

    // –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ rule-–≥—Ä—É–ø–ø—ã, –≤–∫–ª—é—á—ë–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const defaultIndependentRuleNamesApp = [
      "Extra Proxy Domains",
    ];

    // –î–ª—è –ø—Ä–æ—Ñ–∏–ª—è —Ä–æ—É—Ç–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ –≥—Ä—É–ø–ø—ã –∏ –ø—Ä–∞–≤–∏–ª–∞, —á—Ç–æ –∏ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    const defaultProxyGroupsRouter = defaultProxyGroupsApp.slice();
    const defaultIndependentRuleNamesRouter = defaultIndependentRuleNamesApp.slice();

    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —á–µ–∫–±–æ–∫—Å–æ–≤ –≥—Ä—É–ø–ø –ø—Ä–æ–∫—Å–∏ (–ø—Ä–æ—Ñ–∏–ª—å: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
    function initProxyGroups() {
      proxyGroupNamesOrder.forEach(name => {
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∞ –≤—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –±–µ–∑ —á–µ–∫–±–æ–∫—Å–∞
        if (name === "Global-Default") return;
        const wrap = document.createElement("label");
        wrap.className = "checkbox-item";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "cb-proxy-group";
        cb.dataset.name = name;
        cb.checked = defaultProxyGroupsApp.includes(name);
        const span = document.createElement("span");
        span.textContent = name;
        wrap.appendChild(cb);
        wrap.appendChild(span);
        proxyGroupsList.appendChild(wrap);
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä—É–ø–ø –ø—Ä–æ–∫—Å–∏ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è —Ä–æ—É—Ç–µ—Ä–∞
    function initRouterGroups() {
      routerProxyGroupNamesOrder.forEach(name => {
        if (name === "Global-Default") return;
        const wrap = document.createElement("label");
        wrap.className = "checkbox-item";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "cb-router-proxy-group";
        cb.dataset.name = name;
        cb.checked = defaultProxyGroupsRouter.includes(name);
        const span = document.createElement("span");
        span.textContent = name;
        wrap.appendChild(cb);
        wrap.appendChild(span);
        routerProxyGroupsList.appendChild(wrap);
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä—É–ø–ø –ø—Ä–∞–≤–∏–ª –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è —Ä–æ—É—Ç–µ—Ä–∞ (–∫—Ä—É–ø–Ω—ã–µ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏)
    function initRouterRules() {
      routerRuleDefs.forEach(def => {
        const wrap = document.createElement("label");
        wrap.className = "checkbox-item";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "cb-router-rule";
        cb.dataset.key = def.key;
        cb.checked = true;
        const span = document.createElement("span");
        span.textContent = def.label;
        wrap.appendChild(cb);
        wrap.appendChild(span);
        routerRulesList.appendChild(wrap);
      });
    }

    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —á–µ–∫–±–æ–∫—Å–æ–≤ –ø—Ä–∞–≤–∏–ª (—Ç–æ–ª—å–∫–æ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –ø—Ä–∞–≤–∏–ª–∞, –ø—Ä–æ—Ñ–∏–ª—å: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
    function initRules() {
      visibleRuleNamesOrder.forEach(name => {
        const wrap = document.createElement("label");
        wrap.className = "checkbox-item";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "cb-rule-group";
        cb.dataset.name = name;
        cb.checked = defaultIndependentRuleNamesApp.includes(name);
        const span = document.createElement("span");
        span.textContent = name;
        wrap.appendChild(cb);
        wrap.appendChild(span);
        rulesList.appendChild(wrap);
      });
    }

    function getAutoRuleNamesFromGroups(enabledProxyGroups) {
      const set = new Set();
      (enabledProxyGroups || []).forEach(groupName => {
        const rules = groupToRules[groupName] || [];
        rules.forEach(ruleName => set.add(ruleName));
      });
      return Array.from(set);
    }

    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ RegExp
    function escapeRegExp(str) {
      return String(str || "").replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    // –ü–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞ —Ä–æ—É—Ç–µ—Ä–∞: –≤—ã–∫–∏–¥—ã–≤–∞–µ–º –≥—Ä—É–ø–ø—ã –∏ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –æ—Ç–∫–ª—é—á—ë–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø
    function applyRouterGroupFiltering(cfg, enabledRouterProxyGroups) {
      const allGroups = (typeof routerProxyGroupNamesOrder !== "undefined" && Array.isArray(routerProxyGroupNamesOrder))
        ? routerProxyGroupNamesOrder
        : [];
      const enabledSet = new Set(enabledRouterProxyGroups || []);
      const ALWAYS_ON = new Set(["Auto-VPN", "Proxy-Selector", "Global-Default"]);
      const disabled = allGroups.filter(name => name && !ALWAYS_ON.has(name) && !enabledSet.has(name));
      const disabledSet = new Set(disabled);

      if (!disabled.length) return cfg || "";

      const lines = String(cfg || "").split("\n");
      const outLines = [];

      let inProxyGroups = false;
      let skipGroup = false;

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const trimmed = line.trim();

        // –í—Ö–æ–¥–∏–º –≤ —Å–µ–∫—Ü–∏—é proxy-groups
        if (!inProxyGroups && /^proxy-groups\s*:\s*$/.test(trimmed)) {
          inProxyGroups = true;
          skipGroup = false;
          outLines.push(line);
          continue;
        }

        // –ï—Å–ª–∏ –º—ã –≤–Ω—É—Ç—Ä–∏ proxy-groups, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–µ—Ü —Å–µ–∫—Ü–∏–∏
        if (inProxyGroups) {
          if (/^rule-providers\s*:\s*$/.test(trimmed) || /^# 3\. RULE PROVIDERS/.test(trimmed)) {
            inProxyGroups = false;
            skipGroup = false;
            outLines.push(line);
            continue;
          }

          // –ù–∞—á–∞–ª–æ –±–ª–æ–∫–∞ –≥—Ä—É–ø–ø—ã
          if (/^- name: /.test(trimmed)) {
            const name = trimmed.replace(/^- name:\s*/, "").trim();
            if (disabledSet.has(name)) {
              // —ç—Ç—É –≥—Ä—É–ø–ø—É –∏ –µ—ë —Å—Ç—Ä–æ–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
              skipGroup = true;
              continue;
            } else {
              skipGroup = false;
              outLines.push(line);
              continue;
            }
          }

          // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –æ—Ç–∫–ª—é—á—ë–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
          if (skipGroup) continue;

          outLines.push(line);
          continue;
        }

        // –í–Ω–µ proxy-groups: —á–∏—Å—Ç–∏–º —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∞–≤–∏–ª –¥–ª—è –æ—Ç–∫–ª—é—á—ë–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø
        let drop = false;
        if (trimmed.startsWith("- ")) {
          for (const name of disabledSet) {
            if (trimmed.endsWith("," + name)) {
              drop = true;
              break;
            }
          }
        }

        if (!drop) outLines.push(line);
      }

      return outLines.join("\n");
    }



    // -----------------------------
    // –î–µ—Ç–µ–∫—Ü–∏—è –∏ —Ä–∞–∑–±–æ—Ä —Å—Å—ã–ª–æ–∫
    // -----------------------------
    function detectLinkType(raw) {
      const url = String(raw || "").trim().toLowerCase();
      if (!url) return "empty";
      if (url.startsWith("http://") || url.startsWith("https://")) return "subscription";
      if (url.startsWith("vless://")) return "vless";
      if (url.startsWith("vmess://")) return "vmess";
      if (url.startsWith("trojan://")) return "trojan";
      if (url.startsWith("ss://")) return "shadowsocks";
      if (url.startsWith("socks://")) return "socks";
      if (url.startsWith("hysteria2://") || url.startsWith("hy2://")) return "hysteria2";
      return "unknown";
    }

    function parseVlessNode(url) {
      try {
        const u = new URL(url);
        const params = Object.fromEntries(u.searchParams.entries());
        const name = decodeURIComponent(u.hash.replace("#", "")) || "VLESS-Node";
        const security = (params.security || "").toLowerCase();
        const isTls = security === "tls" || security === "reality";
        const node = {
          name,
          type: "vless",
          server: u.hostname,
          port: Number(u.port || 443),
          uuid: u.username,
          udp: true,
          tls: isTls,
          network: params.type || "tcp",
          "skip-cert-verify": true,
        };
        if (params.flow) node.flow = params.flow;
        if (params.sni) {
          node.servername = params.sni;
          node.sni = params.sni;
        }
        if (security === "reality") {
          node.reality = {
            publicKey: params.pbk || "",
            shortId: params.sid || "",
            spiderX: params.spx || "/",
          };
        }
        return node;
      } catch (e) {
        return null;
      }
    }

    function parseVmessNode(url) {
      try {
        const raw = url.replace(/^vmess:\/\//i, "");
        const decoded = JSON.parse(atob(raw));
        return {
          name: decoded.ps || "VMESS-Node",
          type: "vmess",
          server: decoded.add,
          port: Number(decoded.port || 443),
          uuid: decoded.id,
          alterId: decoded.aid ? Number(decoded.aid) : 0,
          cipher: decoded.scy || "auto",
          network: decoded.net || "tcp",
          tls: decoded.tls === "tls",
          "skip-cert-verify": decoded.tls === "tls",
        };
      } catch (e) {
        return null;
      }
    }

    function parseTrojanNode(url) {
      try {
        const u = new URL(url);
        return {
          name: decodeURIComponent(u.hash.replace("#", "")) || "TROJAN-Node",
          type: "trojan",
          server: u.hostname,
          port: Number(u.port || 443),
          password: u.username,
          sni: u.searchParams.get("sni") || undefined,
          udp: true,
          tls: true,
          "skip-cert-verify": true,
        };
      } catch (e) {
        return null;
      }
    }

    function parseSSNode(url) {
      try {
        const raw = url.replace(/^ss:\/\//i, "");
        let method = "", password = "", host = "", port = 0;
        if (raw.includes("@")) {
          const [auth, serverPart] = raw.split("@");
          const creds = atob(auth);
          const parts = creds.split(":");
          method = parts[0];
          password = parts.slice(1).join(":");
          const hp = serverPart.replace(/#.*/, "");
          const hpParts = hp.split(":");
          host = hpParts[0];
          port = Number(hpParts[1] || 0);
        }
        return {
          name: "SS-Node",
          type: "ss",
          server: host,
          port,
          cipher: method,
          password,
          udp: true,
        };
      } catch (e) {
        return null;
      }
    }

    function parseSocksNode(url) {
      try {
        const u = new URL(url);
        return {
          name: decodeURIComponent(u.hash.replace("#", "")) || "SOCKS-Node",
          type: "socks5",
          server: u.hostname,
          port: Number(u.port || 1080),
          username: u.username || undefined,
          password: u.password || undefined,
          udp: true,
        };
      } catch (e) {
        return null;
      }
    }

    function buildSingleProxyNode(url) {
      const kind = detectLinkType(url);
      if (kind === "vless") return parseVlessNode(url);
      if (kind === "vmess") return parseVmessNode(url);
      if (kind === "trojan") return parseTrojanNode(url);
      if (kind === "shadowsocks") return parseSSNode(url);
      if (kind === "socks") return parseSocksNode(url);
      // hysteria2 –∏ –ø—Ä–æ—á–∏–µ —Å–µ–π—á–∞—Å –Ω–µ —Ä–∞–∑–±–∏—Ä–∞–µ–º ‚Äî –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ
      return null;
    }

    function processUserLinks(rawList) {
      const list = Array.isArray(rawList) ? rawList : String(rawList || "").split("\n");
      const subscriptions = [];
      const proxyNodes = [];
      list.forEach(line => {
        const url = String(line || "").trim();
        if (!url) return;
        const kind = detectLinkType(url);
        if (kind === "subscription") {
          subscriptions.push(url);
          return;
        }
        const node = buildSingleProxyNode(url);
        if (node) {
          proxyNodes.push(node);
        }
      });
      return { subscriptions, proxyNodes };
    }

    function buildProxiesSection(proxyNodes) {
      if (!proxyNodes || !proxyNodes.length) return "";
      let out = "# --------- –û–¢–î–ï–õ–¨–ù–´–ï –ü–†–û–ö–°–ò-–£–ó–õ–´ ---------\nproxies:\n";
      proxyNodes.forEach(node => {
        const name = node.name || "Node";
        out += "  - name: " + JSON.stringify(name) + "\n";
        out += "    type: " + node.type + "\n";
        out += "    server: " + JSON.stringify(node.server) + "\n";
        out += "    port: " + Number(node.port || 443) + "\n";
        if (node.uuid) out += "    uuid: " + JSON.stringify(node.uuid) + "\n";
        if (node.password) out += "    password: " + JSON.stringify(node.password) + "\n";
        if (node.cipher) out += "    cipher: " + JSON.stringify(node.cipher) + "\n";
        if (typeof node.alterId === "number") out += "    alterId: " + node.alterId + "\n";
        if (node.username) out += "    username: " + JSON.stringify(node.username) + "\n";
        if (node.tls) out += "    tls: true\n";
        if (node.sni) out += "    sni: " + JSON.stringify(node.sni) + "\n";
        if (node.servername) out += "    servername: " + JSON.stringify(node.servername) + "\n";
        if (node.network) out += "    network: " + JSON.stringify(node.network) + "\n";
        if (node.udp) out += "    udp: true\n";
        if (node["skip-cert-verify"]) out += "    skip-cert-verify: true\n";
        if (node.flow) out += "    flow: " + JSON.stringify(node.flow) + "\n";
        if (node.reality && (node.reality.publicKey || node.reality.shortId || node.reality.spiderX)) {
          out += "    reality-opts:\n";
          if (node.reality.publicKey) out += "      public-key: " + JSON.stringify(node.reality.publicKey) + "\n";
          if (node.reality.shortId) out += "      short-id: " + JSON.stringify(node.reality.shortId) + "\n";
          if (node.reality.spiderX) out += "      spider-x: " + JSON.stringify(node.reality.spiderX) + "\n";
        }
        out += "\n";
      });
      out += "\n";
      return out;
    }

    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é proxy-providers –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    function appBuildProxyProviders(urls) {
      const clean = (urls || []).map(u => String(u).trim()).filter(Boolean);
      const subs = clean.filter(u => /^https?:\/\//i.test(u));
      if (!subs.length) return "";
      let out = APP_PROXY_PROVIDERS_HEADER;
      subs.forEach((url, idx) => {
        const name = `my-vless-sub-${idx + 1}`;
        out += APP_PROXY_PROVIDER_TEMPLATE(name, url);
      });
      out += "\n";
      return out;
    }

    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é proxy-providers –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è —Ä–æ—É—Ç–µ—Ä–∞
    function routerBuildProxyProviders(urls) {
      const clean = (urls || []).map(u => String(u).trim()).filter(Boolean);
      const subs = clean.filter(u => /^https?:\/\//i.test(u));
      let out = ROUTER_PROXY_PROVIDERS_HEADER;
      if (!subs.length) {
        out += "  # —Å—é–¥–∞ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–¥–ø–∏—Å–∫—É (http/https)\n\n";
        return out;
      }
      subs.forEach((url, idx) => {
        const name = ROUTER_PROVIDER_NAMES[idx] || `sub-${idx + 1}`;
        out += routerProviderTemplate(name, url);
      });
      out += "\n";
      return out;
    }

    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≥—Ä—É–ø–ø –ø—Ä–æ–∫—Å–∏ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è,
    // —á—Ç–æ–±—ã –≤—Å–µ–≥–¥–∞ –±—ã–ª–∞ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∞ Global-Default –∏ —á—Ç–æ–±—ã Proxy-Selector
    // –∑–Ω–∞–ª –ø—Ä–æ –æ–¥–∏–Ω–æ—á–Ω—ã–µ —É–∑–ª—ã (proxies)
    function appBuildProxyGroups(enabledGroupNames, providerCount, proxyNodes) {
      let out = APP_PROXY_GROUPS_HEADER;
      let useLines = "";
      if (providerCount > 0) {
        for (let i = 1; i <= providerCount; i++) {
          useLines += `\n      - my-vless-sub-${i}`;
        }
      }

      // Proxy-Selector
      out += `  - name: Proxy-Selector
    type: url-test
    icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Rocket.png"
    use:${useLines}
    url: "http://www.gstatic.com/generate_204"
    interval: 300
    tolerance: 50
    lazy: true`;
      if (proxyNodes && proxyNodes.length) {
        out += "\n    proxies:";
        proxyNodes.forEach(node => {
          const name = node.name || "Node";
          out += "\n      - " + name;
        });
      }
      out += "\n\n";

      (enabledGroupNames || []).forEach(name => {
        if (name === "Global-Default") return;
        const block = APP_PROXY_GROUP_BLOCKS[name];
        if (block) out += block;
      });

      // –§–∏–Ω–∞–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∞ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
      const globalBlock = APP_PROXY_GROUP_BLOCKS["Global-Default"];
      if (globalBlock) out += globalBlock;

      out += "\n";
      return out;
    }

    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é rule-providers –∏ –ø—Ä–∞–≤–∏–ª –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    function appBuildRuleProviders(allRuleNames) {
      const names = (allRuleNames || []).filter(n => n !== "IP Check via Proxy");
      if (!names.length) return "";
      let out = APP_RULE_PROVIDERS_HEADER;
      const added = new Set();
      names.forEach(name => {
        if (!added.has(name) && APP_RULE_PROVIDER_BLOCKS[name]) {
          out += APP_RULE_PROVIDER_BLOCKS[name];
          added.add(name);
        }
      });
      out += "\n";
      return out;
    }

    function appBuildRules(allRuleNames) {
      let out = APP_RULES_HEADER + APP_RULES_BASE_LOCAL;
      (allRuleNames || []).forEach(name => {
        const block = APP_RULE_BLOCKS[name];
        if (block) out += block;
      });
      out += APP_RULES_FOOTER;
      return out;
    }

    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–±–æ—Ä–∫—É –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å —É—á—ë—Ç–æ–º –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —É–∑–ª–æ–≤
    function buildAppConfig(state) {
      const rawSubs = state.subscriptions || [];
      const { subscriptions, proxyNodes } = processUserLinks(rawSubs);
      const enabledProxyGroups = state.enabledProxyGroups || [];
      const independentRuleNames = state.enabledRuleGroups || [];

      const autoRuleNames = getAutoRuleNamesFromGroups(enabledProxyGroups);
      const allRuleNamesSet = new Set([...autoRuleNames, ...independentRuleNames]);
      const allRuleNames = Array.from(allRuleNamesSet);

      let cfg = APP_GLOBAL_HEADER;
      cfg += appBuildProxyProviders(subscriptions);
      cfg += buildProxiesSection(proxyNodes);
      cfg += appBuildProxyGroups(enabledProxyGroups, subscriptions.length, proxyNodes);
      cfg += appBuildRuleProviders(allRuleNames);
      cfg += appBuildRules(allRuleNames);
      return cfg;
    }

    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–±–æ—Ä–∫—É –ø—Ä–æ—Ñ–∏–ª—è —Ä–æ—É—Ç–µ—Ä–∞, —á—Ç–æ–±—ã –æ—Ç–ª–∏—á–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Ç –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
    function buildRouterConfig(state) {
      const rawSubs = state.subscriptions || [];
      const { subscriptions, proxyNodes } = processUserLinks(rawSubs);

      const enabledRouterRuleGroups = state.enabledRouterRuleGroups || [];
      const enabledRouterProxyGroups = state.enabledRouterProxyGroups || [];

      let cfg = ROUTER_GLOBAL_HEADER;
      cfg += routerBuildProxyProviders(subscriptions);
      cfg += buildProxiesSection(proxyNodes);
      cfg += routerBuildProxyGroups(subscriptions.length || 1);
      cfg += ROUTER_RULE_PROVIDERS_BLOCK + "\n";
      cfg += buildRouterRules(enabledRouterRuleGroups);
      cfg = applyRouterGroupFiltering(cfg, enabledRouterProxyGroups);
      return cfg;
    }


initSubscriptions();
    initProxyGroups();
    initRules();
    initRouterGroups();
    initRouterRules();
    refreshPreview();
  </script>
</body>
</html>

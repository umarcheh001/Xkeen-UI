<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Xkeen UI ‚Äî Mihomo –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CodeMirror for YAML editing -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/yaml/yaml.min.js"></script>

  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    body {
      background: #020617;
      color: #e5e7eb;
    }
    .generator-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
      gap: 16px;
    }
    @media (max-width: 960px) {
      .generator-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .card {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 16px;
      box-shadow: 0 18px 35px rgba(15,23,42,0.85);
    }
    .card h2 {
      margin: 0 0 8px;
      font-size: 18px;
    }
    .card small {
      color: #9ca3af;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #9ca3af;
    }
    select,
    input[type="text"],
    textarea {
      width: 100%;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      padding: 6px 8px;
      font-size: 13px;
      box-sizing: border-box;
    }
    select:focus,
    input[type="text"]:focus,
    textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59,130,246,0.5);
    }
    .row-inline {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .row-inline > div {
      flex: 1;
    }
    .subscriptions-list,
    .proxies-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .subscription-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .subscription-row input {
      flex: 1;
    }
    .btn {
      border-radius: 7px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      padding: 5px 10px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-primary {
      border-color: #3b82f6;
      background: radial-gradient(circle at top, rgba(59,130,246,0.24), #020617);
      box-shadow: 0 14px 32px rgba(37,99,235,0.5);
    }
    .btn-ghost {
      border-style: dashed;
      color: #9ca3af;
    }
    .btn-danger {
      border-color: #ef4444;
      color: #fecaca;
      background: radial-gradient(circle at top, rgba(248,113,113,0.16), #020617);
    }
    .btn-xs {
      font-size: 11px;
      padding: 3px 7px;
    }
    .btn + .btn {
      margin-left: 6px;
    }
    .rule-groups-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 4px 8px;
    }
    .rule-group-item {
      display: flex;
      gap: 4px;
      font-size: 12px;
      align-items: flex-start;
    }
    .rule-group-item span {
      color: #9ca3af;
    }
    .proxy-card {
      border-radius: 10px;
      border: 1px solid #374151;
      padding: 8px;
      background: radial-gradient(circle at top left, rgba(59,130,246,0.16), #020617);
    }
    .proxy-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .proxy-header-title {
      font-size: 13px;
      font-weight: 500;
    }
    .proxy-header-type {
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 6px;
      border: 1px solid #4b5563;
      color: #9ca3af;
    }
    .proxy-body {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 6px 8px;
    }
    .proxy-body .full {
      grid-column: 1 / -1;
    }
    @media (max-width: 960px) {
      .proxy-body {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .status-bar {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
    }
    .status-message {
      color: #9ca3af;
    }
    .status-message.ok { color: #bbf7d0; }
    .status-message.err { color: #fecaca; }
    .edit-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: #9ca3af;
      cursor: pointer;
    }
    .CodeMirror {
      border-radius: 8px;
      border: 1px solid #374151;
      height: auto;
      min-height: 340px;
      max-height: 70vh;
    }
    .preview-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
      margin-bottom: 6px;
    }
    .hint {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
    }
    header a {
      color: #93c5fd;
    }
  
    
    .validation-log-panel {
      margin-top: 16px;
      background: #020617;
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 8px 10px 10px;
      max-height: 220px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .validation-log-header {
      font-size: 12px;
      font-weight: 500;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .validation-log {
      margin: 0;
      padding: 6px 8px;
      background: #020617;
      border-radius: 6px;
      border: 1px solid #111827;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      overflow: auto;
    }
    .log-line {
      line-height: 1.35;
      white-space: pre-wrap;
    }
    .log-info {
      color: #60a5fa;
    }
    .log-warn {
      color: #facc15;
    }
    .log-error {
      color: #f87171;
    }
    .log-fatal {
      color: #fb7185;
      font-weight: 600;
    }
    .log-debug {
      color: #9ca3af;
    }
</style>
</head>
<body>
  <div id="global-xkeen-spinner">
    <div class="global-spinner-box">
      <div class="global-spinner-icon"></div>
      <div class="global-spinner-text" id="global-xkeen-spinner-text">
        –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º xkeen‚Ä¶
      </div>
    </div>
  </div>


  <div class="container">
    <header>
      <h1>Mihomo ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–Ω—Ñ–∏–≥–∞</h1>
      <p>
        –ù–æ–≤—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π —Ä–æ—É—Ç–µ—Ä–∞ (bazy ZKeen / –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã).
        <a href="{{ url_for('index') }}">‚Üê –ù–∞–∑–∞–¥ –≤ –æ—Å–Ω–æ–≤–Ω—É—é –ø–∞–Ω–µ–ª—å</a>
      </p>
    </header>

    <div class="generator-layout">
      <!-- LEFT CARD -->
      <div class="card">
        <h2>–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
        <small>–ü—Ä–æ—Ñ–∏–ª—å, —à–∞–±–ª–æ–Ω, –ø–æ–¥–ø–∏—Å–∫–∏, –ø–∞–∫–µ—Ç—ã –≥—Ä—É–ø–ø/–ø—Ä–∞–≤–∏–ª –∏ —É–∑–ª—ã.</small>

        <div style="height:8px"></div>

        <div class="row-inline">
          <div>
            <label for="profileSelect">–ü—Ä–æ—Ñ–∏–ª—å</label>
            <select id="profileSelect">
              <option value="router_custom">–†–æ—É—Ç–µ—Ä (–∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã)</option>
            </select>
          </div>
          <div>
            <label for="templateSelect">–®–∞–±–ª–æ–Ω</label>
            <select id="templateSelect" disabled>
              <option value="auto">(—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: custom.yaml)</option>
            </select>
            <div class="hint">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ–¥–∏–Ω—ã–π —à–∞–±–ª–æ–Ω <code>custom.yaml</code>, –≤—ã–±–æ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</div>
          </div>
        </div>

        <div style="margin-top:4px">
          <label>–ü–æ–¥–ø–∏—Å–∫–∏ (proxy-providers)</label>
          <div id="subscriptionsList" class="subscriptions-list"></div>
          <button type="button" id="addSubscriptionBtn" class="btn btn-ghost btn-xs">
            + –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
          </button>
          <div class="hint">
            –ü–µ—Ä–≤—ã–µ 5 –ø–æ–¥–ø–∏—Å–æ–∫ –∑–∞–ø–æ–ª–Ω—è—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã:
            my-vless-sub, second-sub, third-sub, fourth-sub, fifth-sub.
          </div>
        </div>

        <div style="margin-top:10px">
          <label for="defaultGroupsInput">–ì—Ä—É–ø–ø—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —É–∑–ª–æ–≤</label>
          <input id="defaultGroupsInput" type="text" value="–ó–∞–±–ª–æ–∫. —Å–µ—Ä–≤–∏—Å—ã" placeholder="–ó–∞–±–ª–æ–∫. —Å–µ—Ä–≤–∏—Å—ã,YouTube">
          <div class="hint">
            –ï—Å–ª–∏ —É —É–∑–ª–∞ –Ω–µ –∑–∞–¥–∞–Ω—ã —Å–≤–æ–∏ –≥—Ä—É–ø–ø—ã, –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —ç—Ç–∏.
          </div>
        </div>

        <div style="margin-top:12px">
          <label>–ü–∞–∫–µ—Ç—ã –≥—Ä—É–ø–ø –∏ –ø—Ä–∞–≤–∏–ª</label>
          <div id="ruleGroupsList" class="rule-groups-grid"></div>
          <div class="hint">
            –û—Ç–º–µ—á–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ —à–∞–±–ª–æ–Ω–µ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã/–ø—Ä–∞–≤–∏–ª–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ—Ç.
          </div>
        </div>

        <hr style="margin:14px 0;border-color:#1f2937">

        <div>
          <label>–£–∑–ª—ã (proxies)</label>
          <div id="proxiesList" class="proxies-list"></div>
          <button type="button" id="addProxyBtn" class="btn btn-ghost btn-xs">
            + –î–æ–±–∞–≤–∏—Ç—å —É–∑–µ–ª
          </button>
          <div class="hint">
            –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è VLESS —Å—Å—ã–ª–∫–∏, WireGuard-–∫–æ–Ω—Ñ–∏–≥–∏ –∏ –≥–æ—Ç–æ–≤—ã–µ YAML-–±–ª–æ–∫–∏ proxy.
          </div>
        </div>
      </div>

      <!-- RIGHT CARD -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:8px;">
          <div>
            <h2>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä config.yaml</h2>
            <small>
              –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–≥—Ä—É–∂–µ–Ω –±–∞–∑–æ–≤—ã–π —Å–∫–µ–ª–µ—Ç. –ú–æ–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Ä—É—á–Ω—É—é –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º ¬´–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ¬ª.
            </small>
            <div id="stateSummary" class="hint" style="margin-top:4px;">
              –ü—Ä–æ—Ñ–∏–ª—å: router_custom ¬∑ –®–∞–±–ª–æ–Ω: custom.yaml ¬∑ Rule-–≥—Ä—É–ø–ø: 0 ¬∑ –ü–æ–¥–ø–∏—Å–æ–∫: 0 ¬∑ –ü—Ä–æ–∫—Å–∏: 0
            </div>
          </div>
          <div class="preview-actions">
            <button type="button" id="generateBtn" class="btn btn-primary">
              ‚öôÔ∏è –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å (–¥–µ–º–æ)
            </button>
            <button type="button" id="saveBtn" class="btn">
              üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <button type="button" id="validateBtn" class="btn btn-ghost">
              ü©∫ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
            </button>
            <button type="button" id="applyBtn" class="btn">
              üöÄ –ü—Ä–∏–º–µ–Ω–∏—Ç—å
            </button>
          </div>
        </div>

        <textarea id="previewTextarea" style="display:none;"></textarea>
        <div class="hint">
          –†–µ–∂–∏–º <strong>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</strong> –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—Ä—É—á–Ω—É—é –ø—Ä–∞–≤–∏—Ç—å yaml, –∫–æ—Ç–æ—Ä—ã–π –∑–∞—Ç–µ–º —É—Ö–æ–¥–∏—Ç –Ω–∞ —Ä–æ—É—Ç–µ—Ä.
        </div>

        <div class="status-bar">
          <div id="statusMessage" class="status-message">
            –°–∫–µ–ª–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω. –í–∫–ª—é—á–∏—Ç–µ ¬´–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ¬ª –¥–ª—è —Ä—É—á–Ω—ã—Ö –ø—Ä–∞–≤–æ–∫.
          </div>
          <div>
            <label class="edit-toggle">
              <input type="checkbox" id="editToggle">
              –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            </label>
            <button type="button" id="copyBtn" class="btn btn-ghost btn-xs">
              üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
            </button>
          </div>
        </div>
     
        <div class="validation-log-panel">
          <div class="validation-log-header">
            –õ–æ–≥ –ø—Ä–æ–≤–µ—Ä–∫–∏ mihomo
            <button type="button" id="clearValidationLogBtn" class="btn btn-ghost btn-xs" style="float:right;">
              –û—á–∏—Å—Ç–∏—Ç—å
            </button>
          </div>
          <div id="validationLog" class="validation-log"></div>
        </div>
 </div>
    </div>
  </div>

<script src="{{ url_for('static', filename='main.js') }}"></script>

<script>
(function () {
  // ---- constants ----
  const RULE_GROUP_PRESETS = [
    // –ö–æ–Ω—Ç–µ–Ω—Ç–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
    { id: "YouTube",   label: "YouTube / –≤–∏–¥–µ–æ" },
    { id: "Discord",   label: "Discord" },
    { id: "Twitch",    label: "Twitch" },
    { id: "Reddit",    label: "Reddit" },
    { id: "Spotify",   label: "Spotify" },
    { id: "Steam",     label: "Steam / –∏–≥—Ä—ã" },
    { id: "Telegram",  label: "Telegram" },

    // –ö—Ä—É–ø–Ω—ã–µ —Å–µ—Ç–∏ / CDN / –æ–±–ª–∞–∫–∞
    { id: "Meta",      label: "Meta / Facebook" },
    { id: "Amazon",    label: "Amazon / AWS" },
    { id: "Cloudflare",label: "Cloudflare" },
    { id: "Fastly",    label: "Fastly" },
    { id: "CDN77",     label: "CDN77" },
    { id: "Akamai",    label: "Akamai" },

    // –û–±—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã
    { id: "Google",    label: "Google" },
    { id: "GitHub",    label: "GitHub" },
    { id: "AI",        label: "AI —Å–µ—Ä–≤–∏—Å—ã" },

    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∞
    // QUIC –∏ –±–∞–∑–æ–≤–∞—è –≥—Ä—É–ø–ø–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω—ã –∏ –Ω–µ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∏–∑ UI
  ];

  const SKELETON = `#######################################################################################################
# –û–ø–∏—Å–∞–Ω–∏–µ:
# –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É http://192.168.1.1:9090/ui (–≤–º–µ—Å—Ç–æ 192.168.1.1 –º–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±–æ–π IP, –≥–¥–µ –∑–∞–ø—É—â–µ–Ω –¥–∞–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥). –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∑–∞–ø—É—Å–∫–∞ mihomo –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–π—Ç–∏ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ –≤—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–∫—Å–∏-–≥—Ä—É–ø–ø
# –ì—Ä—É–ø–ø–∞ "–ó–∞–±–ª–æ–∫. —Å–µ—Ä–≤–∏—Å—ã" —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ (–∫–∞–∫ —Å–Ω–∞—Ä—É–∂–∏, —Ç–∞–∫ –∏ –≤–Ω—É—Ç—Ä–∏)
# –û—Å—Ç–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã YouTube/Discord –∏ —Ç–¥ –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –≥—Ä—É–ø–ø–æ–π "–ó–∞–±–ª–æ–∫. —Å–µ—Ä–≤–∏—Å—ã". E—Å–ª–∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ –Ω—É–∂–Ω–æ, –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å "–ó–∞–±–ª–æ–∫. —Å–µ—Ä–≤–∏—Å—ã" –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –≤—Å–µ–º–∏ –≥—Ä—É–ø–ø–∞–º–∏ —Ä–∞–∑–æ–º –≤ –≥—Ä—É–ø–ø–µ "–ó–∞–±–ª–æ–∫. —Å–µ—Ä–≤–∏—Å—ã"
#######################################################################################################
# –î–ª—è —Ä–∞–±–æ—Ç—ã Discord —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—Ç—ã XKeen: 80,443,2000:2300,8443,19200:19400,50000:50030
# –î–ª—è —Ä–∞–±–æ—Ç—ã Whatsapp/Telegram —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—Ç—ã Xkeen: 80,443,596:599,1400,3478,5222
#######################################################################################################

log-level: silent
allow-lan: true
redir-port: 5000
tproxy-port: 5001
ipv6: true
mode: rule
external-controller: 0.0.0.0:9090
external-ui: zashboard
external-ui-url: https://github.com/Zephyruso/zashboard/releases/latest/download/dist.zip
profile: { store-selected: true }

sniffer:
  enable: true
  sniff:
    HTTP:
    TLS:
    QUIC:

anchors:
  a1: &domain { type: http, format: mrs, behavior: domain, interval: 86400 }
  a2: &ipcidr { type: http, format: mrs, behavior: ipcidr, interval: 86400 }
  a3: &classical { type: http, format: text, behavior: classical, interval: 86400 }
  a4: &inline { type: inline, behavior: classical }

#############################################################################################
# –ü—Ä–∏–º–µ—Ä VLESS –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ë–ï–ó –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ #
#############################################################################################


######################################################################################
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –° –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ #
######################################################################################


proxy-groups:
  - name: –ó–∞–±–ª–æ–∫. —Å–µ—Ä–≤–∏—Å—ã
    type: select
    icon: https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Reject.png
    include-all: true

  - name: QUIC
    type: select
    icon: https://github.com/zxc-rv/assets/raw/refs/heads/main/group-icons/quic.png
    proxies: [REJECT, PASS]

  - MATCH,DIRECT
`;


  // ---- DOM refs ----
  const profileSelect = document.getElementById("profileSelect");
  const templateSelect = document.getElementById("templateSelect");
  const defaultGroupsInput = document.getElementById("defaultGroupsInput");
  const subscriptionsList = document.getElementById("subscriptionsList");
  const addSubscriptionBtn = document.getElementById("addSubscriptionBtn");
  const ruleGroupsList = document.getElementById("ruleGroupsList");
  const proxiesList = document.getElementById("proxiesList");
  const addProxyBtn = document.getElementById("addProxyBtn");
  const generateBtn = document.getElementById("generateBtn");
  const saveBtn = document.getElementById("saveBtn");
  const validateBtn = document.getElementById("validateBtn");
  const applyBtn = document.getElementById("applyBtn");
  const editToggle = document.getElementById("editToggle");
  const copyBtn = document.getElementById("copyBtn");
  const statusMessage = document.getElementById("statusMessage");
  const previewTextarea = document.getElementById("previewTextarea");
  const validationLogEl = document.getElementById("validationLog");
  const clearValidationLogBtn = document.getElementById("clearValidationLogBtn");

 
  let validationLogRaw = "";

  function escapeHtml(str) {
    if (!str) return "";
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function formatLogHtml(text) {
    if (!text) return "";
    const lines = String(text).replace(/\r\n/g, "\n").split("\n");
    return lines.map((line) => {
      const safe = escapeHtml(line);
      let cls = "log-line";
      if (/fatal|panic/i.test(line)) cls += " log-fatal";
      else if (/error|\berr\b|err\[/i.test(line)) cls += " log-error";
      else if (/warn/i.test(line)) cls += " log-warn";
      else if (/info/i.test(line)) cls += " log-info";
      else if (/debug/i.test(line)) cls += " log-debug";
      return '<div class="' + cls + '">' + (safe || "&nbsp;") + "</div>";
    }).join("");
  }

  let editor = null;

  // ---- auto-preview helpers ----
  let previewTimeout = null;

  function schedulePreview(delay = 300) {
    if (!editor) return;
    clearTimeout(previewTimeout);
    previewTimeout = setTimeout(() => {
      generatePreviewDemo();
    }, delay);
  }

  /**
   * –í–µ—à–∞–µ—Ç –∞–≤—Ç–æ–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç.
   * @param {HTMLElement|null} el - —ç–ª–µ–º–µ–Ω—Ç
   * @param {string[]} events - —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ["change", "blur"]
   * @param {number} delay - –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º –≤ –º—Å
   */
  function autoPreviewOnChange(el, events = ["change", "blur"], delay = 300) {
    if (!el) return;
    const handler = () => schedulePreview(delay);
    events.forEach(ev => el.addEventListener(ev, handler));
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞–¥ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º
  function updateStateSummary(state) {
    const el = document.getElementById("stateSummary");
    if (!el) return;
    const profile = state.profile || "router_custom";
    const template = state.template || "auto";
    const subs = (state.subscriptions || []).length;
    const proxies = (state.proxies || []).length;
    const enabledRuleGroups = state.enabledRuleGroups || [];
    const rgCount = enabledRuleGroups.length || 0;
    el.textContent =
      "–ü—Ä–æ—Ñ–∏–ª—å: " + profile +
      " ¬∑ –®–∞–±–ª–æ–Ω: " + template +
      " ¬∑ Rule-–≥—Ä—É–ø–ø: " + rgCount +
      " ¬∑ –ü–æ–¥–ø–∏—Å–æ–∫: " + subs +
      " ¬∑ –ü—Ä–æ–∫—Å–∏: " + proxies;
  }

  // –ú–∏–Ω–∏-–≤–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º / –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º
  function validateState(state, mode) {
    const warnings = [];
    const errors = [];
    const subs = state.subscriptions || [];
    const proxies = state.proxies || [];
    const defaultGroups = state.defaultGroups || [];

    // –ù–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—Ä–æ–∫—Å–∏
    if (!subs.length && !proxies.length) {
      if (mode === "apply") {
        errors.push("–ù–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ —É–∑–ª–∞-–ø—Ä–æ–∫—Å–∏ ‚Äì –ø—Ä–∏–º–µ–Ω—è—Ç—å —Ç–∞–∫–æ–π –∫–æ–Ω—Ñ–∏–≥ –æ–ø–∞—Å–Ω–æ.");
      } else {
        warnings.push("–ù–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ —É–∑–ª–∞-–ø—Ä–æ–∫—Å–∏ ‚Äì –∫–æ–Ω—Ñ–∏–≥ –±—É–¥–µ—Ç –±–µ–∑ –ø—Ä–æ–∫—Å–∏.");
      }
    }

    // –ü—Ä–æ—Ñ–∏–ª—å app ‚Äì –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    if (state.profile === "app") {
      warnings.push("–ü—Ä–æ—Ñ–∏–ª—å ¬´app¬ª: –ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞, –∫–æ–Ω—Ñ–∏–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –∫–ª–∏–µ–Ω—Ç.");
    }

    // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if (defaultGroups.length) {
      const knownIds = new Set(RULE_GROUP_PRESETS.map(p => p.id));
      const builtins = new Set(["Proxy-Selector", "Auto-VPN", "Global-Default"]);
      const unknown = defaultGroups.filter(g => !knownIds.has(g) && !builtins.has(g));
      if (unknown.length) {
        warnings.push(
          "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: " +
          unknown.join(", ") +
          ". –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–∞–∫–∏–µ proxy-groups —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ —à–∞–±–ª–æ–Ω–µ."
        );
      }
    }

    return { valid: errors.length === 0, warnings, errors };
  }

  // –ê–≤—Ç–æ–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è / —à–∞–±–ª–æ–Ω–∞ / —Å–ø–∏—Å–∫–æ–≤ –≥—Ä—É–ø–ø
  autoPreviewOnChange(profileSelect, ["change"]);
  autoPreviewOnChange(templateSelect, ["change"]);
  autoPreviewOnChange(defaultGroupsInput, ["input", "change", "blur"]);

  // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≤—Ç–æ–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–æ–∫—Å–∏
  if (proxiesList) {
    // input/select –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–µ–∫
    proxiesList.addEventListener("change", (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      if (target.matches("input, select")) {
        schedulePreview();
      }
    });

    // textarea (WG/yaml –∫–æ–Ω—Ñ–∏–≥–∏) ‚Äî –ø–æ input
    proxiesList.addEventListener("input", (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      if (target.matches("textarea")) {
        schedulePreview(400);
      }
    });

    // —Å—Ç—Ä–∞—Ö—É–µ–º—Å—è –Ω–∞ blur
    proxiesList.addEventListener(
      "blur",
      (e) => {
        const target = e.target;
        if (!(target instanceof HTMLElement)) return;
        if (target.matches("input, textarea, select")) {
          schedulePreview();
        }
      },
      true
    );
  }


  function setStatus(text, type) {
    statusMessage.textContent = text;
    statusMessage.classList.remove("ok", "err");
    if (type === "ok") statusMessage.classList.add("ok");
    if (type === "err") statusMessage.classList.add("err");
  }
  function setValidationLog(text) {
    if (!validationLogEl) return;
    validationLogRaw = text || "";
    validationLogEl.innerHTML = formatLogHtml(validationLogRaw);
    validationLogEl.scrollTop = validationLogEl.scrollHeight;
  }

  function appendValidationLog(text) {
    if (!validationLogEl) return;
    const extra = text || "";
    validationLogRaw = validationLogRaw
      ? validationLogRaw + "\n" + extra
      : extra;
    validationLogEl.innerHTML = formatLogHtml(validationLogRaw);
    validationLogEl.scrollTop = validationLogEl.scrollHeight;
  }

  function jumpToErrorPositionFromLog(log) {
    if (!editor || !log) return;
    // –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤–∏–¥–∞ "line 12 column 5" –∏–ª–∏ "at line 23, column 1"
    const re = /(line|—Å—Ç—Ä–æ–∫–∞)[^0-9]*(\d+)[^0-9]+(column|col|—Å—Ç–æ–ª–±–µ—Ü)?[^0-9]*(\d+)?/i;
    const m = log.match(re);
    if (!m) return;
    const lineNum = parseInt(m[2], 10);
    const colNum = m[4] ? parseInt(m[4], 10) : 1;
    if (!Number.isFinite(lineNum) || lineNum <= 0) return;
    const line = lineNum - 1;
    const ch = colNum > 0 ? colNum - 1 : 0;
    try {
      editor.setCursor({ line, ch });
      editor.scrollIntoView({ line, ch }, 100);
      // –∫—Ä–∞—Ç–∫–æ –ø–æ–¥—á–µ—Ä–∫–Ω—ë–º —Å—Ç—Ä–æ–∫—É —Å—Ç–∞—Ç—É—Å–æ–º
      setStatus("–û—à–∏–±–∫–∞ –æ–∫–æ–ª–æ —Å—Ç—Ä–æ–∫–∏ " + lineNum + ", —Å—Ç–æ–ª–±–µ—Ü " + colNum + ".", "err");
    } catch (e) {
      console.warn("Failed to move cursor to error position", e);
    }
  }


  // ----- CodeMirror init -----
  function initEditor() {
    if (editor) return;
    previewTextarea.value = SKELETON;
    editor = CodeMirror.fromTextArea(previewTextarea, {
      mode: "text/x-yaml",
      theme: "material-darker",
      lineNumbers: true,
      lineWrapping: true,
      readOnly: "nocursor"
    });
    editor.setValue(SKELETON);
  }

  // ----- subscriptions -----
  function createSubscriptionRow(value) {
    const row = document.createElement("div");
    row.className = "subscription-row";

    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "https://example.com/sub";
    input.value = value || "";

    // –ê–≤—Ç–æ–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ URL –ø–æ–¥–ø–∏—Å–∫–∏
    autoPreviewOnChange(input, ["change", "blur", "input"], 400);

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "btn btn-ghost btn-xs";
    btn.textContent = "‚úï";
    btn.onclick = () => {
      subscriptionsList.removeChild(row);
      if (!subscriptionsList.children.length) {
        subscriptionsList.appendChild(createSubscriptionRow(""));
      }
      schedulePreview();
    };

    row.appendChild(input);
    row.appendChild(btn);
    return row;
  }

  function addInitialSubscriptionRow() {
    if (!subscriptionsList.children.length) {
      subscriptionsList.appendChild(createSubscriptionRow(""));
    }
  }

  // ----- rule groups -----
  function renderRuleGroups() {
    RULE_GROUP_PRESETS.forEach(preset => {
      const label = document.createElement("label");
      label.className = "rule-group-item";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.value = preset.id;
      cb.className = "rule-group-checkbox";

      const span = document.createElement("span");
      span.innerHTML = "<strong>" + preset.label + "</strong>";

      label.appendChild(cb);
      label.appendChild(span);
      ruleGroupsList.appendChild(label);

      cb.addEventListener("change", () => {
        // –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø–∞–∫–µ—Ç–æ–≤ –ø—Ä–∞–≤–∏–ª
        schedulePreview();
      });
    });
  }

  
  // ----- proxies -----
  const proxyControllers = [];

  function createProxyCard(initial) {
    const idx = proxyControllers.length + 1;
    const wrapper = document.createElement("div");
    wrapper.className = "proxy-card";

    const header = document.createElement("div");
    header.className = "proxy-header";

    const title = document.createElement("div");
    title.className = "proxy-header-title";
    title.textContent = "–£–∑–µ–ª #" + idx;

    const typeBadge = document.createElement("span");
    typeBadge.className = "proxy-header-type";
    typeBadge.textContent = "–¢–∏–ø: vless";

    const actions = document.createElement("div");

    const delBtn = document.createElement("button");
    delBtn.type = "button";
    delBtn.className = "btn btn-danger btn-xs";
    delBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
    delBtn.onclick = () => {
      const pos = proxyControllers.indexOf(ctrl);
      if (pos >= 0) proxyControllers.splice(pos, 1);
      proxiesList.removeChild(wrapper);
      Array.from(proxiesList.children).forEach((card, i) => {
        const t = card.querySelector(".proxy-header-title");
        if (t) t.textContent = "–£–∑–µ–ª #" + (i + 1);
      });
    };

    actions.appendChild(delBtn);
    header.appendChild(title);
    header.appendChild(typeBadge);
    header.appendChild(actions);

    const body = document.createElement("div");
    body.className = "proxy-body";

    const typeWrap = document.createElement("div");
    const typeLabel = document.createElement("label");
    typeLabel.textContent = "–¢–∏–ø —É–∑–ª–∞";
    const typeSelect = document.createElement("select");
    typeSelect.innerHTML = `
      <option value="vless">VLESS —Å—Å—ã–ª–∫–∞</option>
      <option value="wireguard">WireGuard –∫–æ–Ω—Ñ–∏–≥</option>
      <option value="yaml">YAML –±–ª–æ–∫ proxy</option>
    `;
    typeWrap.appendChild(typeLabel);
    typeWrap.appendChild(typeSelect);

    const nameWrap = document.createElement("div");
    const nameLabel = document.createElement("label");
    nameLabel.textContent = "–ò–º—è —É–∑–ª–∞";
    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.placeholder = "My Node";
    nameWrap.appendChild(nameLabel);
    nameWrap.appendChild(nameInput);

    const groupsWrap = document.createElement("div");
    groupsWrap.className = "full";
    const groupsLabel = document.createElement("label");
    groupsLabel.textContent = "–ì—Ä—É–ø–ø—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)";
    const groupsInput = document.createElement("input");
    groupsInput.type = "text";
    groupsInput.placeholder = "–ó–∞–±–ª–æ–∫. —Å–µ—Ä–≤–∏—Å—ã,YouTube";
    groupsWrap.appendChild(groupsLabel);
    groupsWrap.appendChild(groupsInput);

    const dataWrap = document.createElement("div");
    dataWrap.className = "full";
    const dataLabel = document.createElement("label");
    dataLabel.textContent = "VLESS —Å—Å—ã–ª–∫–∞";
    const dataArea = document.createElement("textarea");
    dataArea.rows = 4;
    dataArea.placeholder = "vless://...";
    dataWrap.appendChild(dataLabel);
    dataWrap.appendChild(dataArea);

    body.appendChild(typeWrap);
    body.appendChild(nameWrap);
    body.appendChild(groupsWrap);
    body.appendChild(dataWrap);

    function updateTypeUI() {
      const t = typeSelect.value;
      if (t === "vless") {
        typeBadge.textContent = "–¢–∏–ø: vless";
        dataLabel.textContent = "VLESS —Å—Å—ã–ª–∫–∞";
        dataArea.placeholder = "vless://...";
        dataArea.rows = 4;
      } else if (t === "wireguard") {
        typeBadge.textContent = "–¢–∏–ø: wireguard";
        dataLabel.textContent = "WireGuard –∫–æ–Ω—Ñ–∏–≥";
        dataArea.placeholder = "[Interface]\nAddress = ...";
        dataArea.rows = 6;
      } else {
        typeBadge.textContent = "–¢–∏–ø: yaml";
        dataLabel.textContent = "YAML –±–ª–æ–∫ proxy";
        dataArea.placeholder = "- name: MyNode\n  type: trojan\n  server: ...";
        dataArea.rows = 6;
      }
    }
    typeSelect.addEventListener("change", updateTypeUI);
    updateTypeUI();

    if (initial) {
      if (initial.kind) typeSelect.value = initial.kind;
      if (initial.name) nameInput.value = initial.name;
      if (initial.groups) groupsInput.value = initial.groups;
      if (initial.data) dataArea.value = initial.data;
      updateTypeUI();
    }

    wrapper.appendChild(header);
    wrapper.appendChild(body);

    const ctrl = {
      el: wrapper,
      getState: () => {
        const kind = typeSelect.value;
        const name = nameInput.value.trim();
        const groups = (groupsInput.value || "")
          .split(",")
          .map(s => s.trim())
          .filter(Boolean);
        const data = dataArea.value;
        if (!data.trim()) return null;
        const out = { kind };
        if (name) out.name = name;
        if (groups.length) out.groups = groups;
        if (kind === "vless") out.link = data.trim();
        else if (kind === "wireguard") out.config = data;
        else out.yaml = data;
        return out;
      },
    };

    proxiesList.appendChild(wrapper);
    proxyControllers.push(ctrl);
  }

  // ----- collect state -----
  function collectState() {
    const profile = profileSelect.value || "router_custom";
    const tval = templateSelect.value;
    const template = tval && tval !== "auto" ? tval : null;

    const subscriptions = Array.from(
      subscriptionsList.querySelectorAll("input[type='text']")
    )
      .map(i => i.value.trim())
      .filter(Boolean);

    const defaultGroups = (defaultGroupsInput.value || "")
      .split(",")
      .map(s => s.trim())
      .filter(Boolean);

    const enabledRuleGroups = Array.from(
      document.querySelectorAll(".rule-group-checkbox")
    )
      .filter(cb => cb.checked)
      .map(cb => cb.value);

    const proxies = proxyControllers
      .map(c => c.getState())
      .filter(Boolean);

    const state = { profile, subscriptions, proxies };
    if (template) state.template = template;
    if (defaultGroups.length) state.defaultGroups = defaultGroups;
    if (enabledRuleGroups.length) state.enabledRuleGroups = enabledRuleGroups;
    return state;
  }

  // ----- generate demo preview on client -----
  function generatePreviewDemo() {
    const state = collectState();
    const payload = { state };
    if (!editor) {
      setStatus("Editor not initialised.", "err");
      return;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –º–∏–Ω–∏-–≤–∞–ª–∏–¥–∞—Ü–∏—é
    updateStateSummary(state);
    const { valid, warnings, errors } = validateState(state, "preview");
    if (!valid && errors.length) {
      setStatus(errors.join(" "), "err");
      return;
    }
    if (warnings.length) {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤—Å—ë —Ä–∞–≤–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
      setStatus(warnings.join(" "), null);
    } else {
      setStatus("–ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...", "ok");
    }

    fetch("/api/mihomo/preview", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    })
      .then(resp => resp.json().then(data => ({ ok: resp.ok, data })))
      .then(({ ok, data }) => {
        if (!ok || !data || data.ok === false) {
          const msg = (data && (data.error || data.message)) || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä.";
          setStatus(msg, "err");
          return;
        }
        const cfg = data.content || data.config || "";
        if (!cfg.trim()) {
          setStatus("–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞.", "err");
          return;
        }
        editor.setValue(cfg);
        setStatus("–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.", "ok");
      })
      .catch(err => {
        console.error("preview error", err);
        setStatus("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞: " + err, "err");
      });
  }

  // ----- download config -----
  function downloadConfig() {
    const text = editor ? editor.getValue() : "";
    if (!text.trim()) {
      setStatus("–ù–µ—á–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å ‚Äì —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø—É—Å—Ç.", "err");
      return;
    }
    const blob = new Blob([text], { type: "text/yaml" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "config.yaml";
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 0);
    setStatus("config.yaml —Å–∫–∞—á–∞–Ω –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä.", "ok");
  }

  
  // ----- validate via mihomo core -----
  
  function showValidationModal(text) {
    const modal = document.getElementById("validationModal");
    const body = document.getElementById("validationModalBody");
    if (!modal || !body) return;

    const raw = text == null ? "" : String(text);
    body.innerHTML = formatLogHtml(raw);

    // –ø–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É
    modal.classList.remove("hidden");
    document.body.classList.add("modal-open");
  }

  function hideValidationModal() {
    const modal = document.getElementById("validationModal");
    if (!modal) return;

    // —Å–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
    modal.classList.add("hidden");
    document.body.classList.remove("modal-open");
  }

  // Expose modal controls globally so inline onclick handlers work
  window.showValidationModal = showValidationModal;
  window.hideValidationModal = hideValidationModal;

  // ----- validate via mihomo core -----
  async function validateConfigOnServer(showPopup = true) {
    const cfg = editor ? editor.getValue() : "";
    if (!cfg.trim()) {
      setStatus("–ù–µ—á–µ–≥–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å ‚Äì –∫–æ–Ω—Ñ–∏–≥ –ø—É—Å—Ç.", "err");
      return { ok: false };
    }
    setStatus("–ü—Ä–æ–≤–µ—Ä—è—é –∫–æ–Ω—Ñ–∏–≥ —á–µ—Ä–µ–∑ mihomo...", "ok");
    try {
      const res = await fetch("/api/mihomo/validate_raw", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ config: cfg }),
      });
      const data = await res.json();
      const log = data && data.log ? data.log : "";
      if (typeof log === "string" && log.trim()) {
        setValidationLog(log);
        jumpToErrorPositionFromLog(log);
        if (showPopup) {
          showValidationModal(log);
        }
      }
      if (!res.ok) {
        setStatus("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞: " + (data && (data.error || res.status)), "err");
        return { ok: false, log };
      }
      const firstLine = (log.split("\n").find(l => l.trim()) || "").trim();
      if (data.ok) {
        const msg = firstLine || "mihomo —Å–æ–æ–±—â–∞–µ—Ç, —á—Ç–æ –∫–æ–Ω—Ñ–∏–≥ –≤–∞–ª–∏–¥–µ–Ω (exit code 0).";
        setStatus(msg, "ok");
        return { ok: true, log };
      } else {
        const msg = firstLine || "mihomo —Å–æ–æ–±—â–∏–ª –æ–± –æ—à–∏–±–∫–µ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–Ω—Ñ–∏–≥–∞.";
        setStatus("–í —Ç–∞–∫–æ–º –≤–∏–¥–µ –∫–æ–Ω—Ñ–∏–≥ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å: " + msg, "err");
        return { ok: false, log };
      }
    } catch (e) {
      setStatus("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–Ω—Ñ–∏–≥–∞: " + e, "err");
      return { ok: false };
    }
  }

// ----- apply to router -----
  async function applyToRouter() {
    const state = collectState();
    const cfg = editor ? editor.getValue() : "";
    if (!cfg.trim()) {
      setStatus("–ù–µ—á–µ–≥–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å ‚Äì –∫–æ–Ω—Ñ–∏–≥ –ø—É—Å—Ç.", "err");
      return;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –º–∏–Ω–∏-–≤–∞–ª–∏–¥–∞—Ü–∏—é
    updateStateSummary(state);
    const { valid, warnings, errors } = validateState(state, "apply");
    if (!valid && errors.length) {
      setStatus(errors.join(" "), "err");
      return;
    }

    // –ü–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≥–æ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥ —á–µ—Ä–µ–∑ mihomo -t
    const validation = await validateConfigOnServer(false);
    if (!validation.ok) {
      // –ü–æ–¥—Ä–æ–±–Ω—ã–π —Ç–µ–∫—Å—Ç —É–∂–µ –≤—ã–≤–µ–¥–µ–Ω –≤ —Å—Ç–∞—Ç—É—Å–µ, –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä—É–µ–º.
      return;
    }

    if (warnings.length) {
      // –î–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é
      setStatus(warnings.join(" "), "err");
    } else {
      setStatus("–û—Ç–ø—Ä–∞–≤–ª—è—é –∫–æ–Ω—Ñ–∏–≥ –Ω–∞ —Ä–æ—É—Ç–µ—Ä...", "ok");
    }

    const payload = { state, configOverride: cfg };
    try {
      const res = await fetch("/api/mihomo/generate_apply", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (!res.ok || !data.ok) {
        setStatus("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏: " + (data.error || res.status), "err");
        return;
      }
      setStatus("–ö–æ–Ω—Ñ–∏–≥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Ä–æ—É—Ç–µ—Ä, xkeen –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è.", "ok");
    } catch (e) {
      setStatus("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + e, "err");
    }
  }

  // ----- copy -----
  function copyConfig() {
    const text = editor ? editor.getValue() : "";
    if (!navigator.clipboard) {
      const t = document.createElement("textarea");
      t.value = text;
      document.body.appendChild(t);
      t.select();
      try {
        document.execCommand("copy");
        setStatus("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä (—á–µ—Ä–µ–∑ fallback).", "ok");
      } catch (e) {
        setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.", "err");
      } finally {
        document.body.removeChild(t);
      }
      return;
    }
    navigator.clipboard.writeText(text).then(
      () => setStatus("–ö–æ–Ω—Ñ–∏–≥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.", "ok"),
      () => setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.", "err")
    );
  }

  // ----- edit toggle -----
  function setEditable(flag) {
    if (!editor) return;
    if (flag) {
      editor.setOption("readOnly", false);
      setStatus("–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∫–ª—é—á—ë–Ω.", "ok");
    } else {
      editor.setOption("readOnly", "nocursor");
      setStatus("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ, –∫–æ–Ω—Ñ–∏–≥ –∑–∞—â–∏—â—ë–Ω –æ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö –ø—Ä–∞–≤–æ–∫.", null);
    }
  }

  // ----- init -----
  document.addEventListener("DOMContentLoaded", () => {
    initEditor();
    addInitialSubscriptionRow();
    renderRuleGroups();
    setStatus("–°–∫–µ–ª–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è —Å–ª–µ–≤–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å¬ª.", null);
  });

  addSubscriptionBtn.onclick = () => {
    subscriptionsList.appendChild(createSubscriptionRow(""));
  };
  addProxyBtn.onclick = () => createProxyCard();
  generateBtn.onclick = generatePreviewDemo;
  saveBtn.onclick = downloadConfig;
  validateBtn.onclick = () => { validateConfigOnServer(); };
  applyBtn.onclick = applyToRouter;
  copyBtn.onclick = copyConfig;
  if (clearValidationLogBtn) {
    clearValidationLogBtn.onclick = () => setValidationLog("");
  }
  editToggle.addEventListener("change", () => setEditable(editToggle.checked));

})();
</script>

<div id="validationModal" class="modal hidden" onclick="if (event.target === this) hideValidationModal();">
  <div class="modal-content">
    <div class="modal-header">
      <span class="modal-title">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Mihomo</span>
      <button type="button" class="modal-close" onclick="hideValidationModal()">√ó</button>
    </div>
    <div id="validationModalBody" class="modal-body modal-body-logs"></div>
  </div>
</div>
</body>
</html>